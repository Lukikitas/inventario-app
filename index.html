<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 flex flex-col h-[90vh] relative">
        
        <div id="loading-view" class="view absolute inset-0 flex flex-col items-center justify-center text-center p-4">
            <h1 class="text-2xl font-bold text-white">Conectando...</h1>
        </div>

        <div id="login-view" class="view hidden absolute inset-0 flex flex-col items-center justify-center text-center p-4">
            <h1 id="auth-title" class="text-4xl font-bold text-white mb-4">Iniciar Sesión</h1>
            <p class="text-gray-400 mb-8">Ingresa a tu cuenta para ver tu inventario.</p>
            
            <div class="w-full space-y-4">
                <input type="email" id="email-input" placeholder="Correo electrónico" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500">
                <input type="password" id="password-input" placeholder="Contraseña" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500">
            </div>
            
            <button id="auth-action-btn" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Iniciar Sesión</button>

            <p class="text-sm text-gray-400 mt-4">
                <span id="auth-toggle-text">¿No tienes cuenta?</span>
                <button id="auth-toggle-btn" class="font-semibold text-indigo-400 hover:text-indigo-300">Regístrate</button>
            </p>

            <div id="login-error-message" class="mt-4 text-red-400 text-sm"></div>
        </div>

        <div id="main-content" class="hidden flex-grow overflow-hidden relative">
            <div id="main-menu-view" class="view absolute inset-0 flex flex-col text-center">
                <div class="p-4 bg-gray-900 rounded-t-xl">
                    <p class="text-xs text-gray-400">Sesión iniciada como:</p>
                    <p id="user-email" class="text-sm font-semibold truncate"></p>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center">
                    <h1 class="text-4xl font-bold text-white mb-8">Inventario KFC</h1>
                    <div class="w-full space-y-3 px-4">
                        <button id="continue-inventory-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Continuar Inventario</button>
                        <button id="continue-order-btn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg">Continuar Pedido</button>
                        <button id="start-new-inventory-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Nuevo Inventario</button>
                        <button id="make-order-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Hacer Pedido</button>
                        <button id="consumption-report-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Reporte de Consumo</button>
                        <button id="history-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Ver Historial</button>
                        <button id="manage-items-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Gestionar Ítems</button>
                    </div>
                </div>
                <div class="p-4">
                    <button id="logout-btn" class="text-sm text-red-400 hover:text-red-300">Cerrar Sesión</button>
                </div>
            </div>
            
            <div id="consumption-setup-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-menu-from-consumption-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-xl font-bold text-center text-gray-100">Reporte de Consumo</h1>
                    <div class="w-8"></div>
                </div>
                <div class="w-full space-y-4">
                    <div>
                        <label for="start-inventory-select" class="block text-sm font-medium text-gray-300 mb-1">Inventario Inicial</label>
                        <select id="start-inventory-select" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600"></select>
                    </div>
                    <div>
                        <label for="end-inventory-select" class="block text-sm font-medium text-gray-300 mb-1">Inventario Final</label>
                        <select id="end-inventory-select" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600"></select>
                    </div>
                </div>
                <button id="generate-consumption-report-btn" class="mt-8 w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-4 rounded-lg">Generar Reporte</button>
                <button id="start-comparison-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg">Comparar Períodos</button>
                <div id="comparison-container" class="w-full space-y-4 mt-4 hidden">
                    <div>
                        <label for="start-inventory-select-2" class="block text-sm font-medium text-gray-300 mb-1">Inventario Inicial (Período 2)</label>
                        <select id="start-inventory-select-2" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600"></select>
                    </div>
                    <div>
                        <label for="end-inventory-select-2" class="block text-sm font-medium text-gray-300 mb-1">Inventario Final (Período 2)</label>
                        <select id="end-inventory-select-2" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600"></select>
                    </div>
                    <button id="generate-comparison-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hidden">Generar Comparación</button>
                </div>
            </div>

            <div id="consumption-result-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-consumption-setup-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-xl font-bold text-center text-gray-100">Resultado del Reporte</h1>
                    <div class="w-8"></div>
                </div>
                <input type="text" id="consumption-search" placeholder="Buscar ítem" class="mb-4 bg-gray-700 text-white p-2 rounded-lg">
                <div id="consumption-result-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
            </div>

            <div id="select-inventory-view" class="view hidden absolute inset-0 flex flex-col h-full">
                 <div class="flex items-center justify-between mb-4">
                    <button id="back-to-menu-from-select-inv-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-2xl font-bold text-center text-gray-100">Base para Pedido</h1>
                    <div class="w-8"></div>
                </div>
                <p class="text-center text-gray-400 mb-4">Selecciona un inventario como base.</p>
                <div id="select-inventory-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
            </div>

            <div id="setup-order-view" class="view hidden absolute inset-0 flex flex-col h-full items-center justify-center text-center">
                <h1 class="text-3xl font-bold mb-8">Fecha del Pedido</h1>
                <p class="text-gray-400 mb-4">¿Para qué día es este pedido?</p>
                <div class="w-full space-y-4">
                    <input type="date" id="order-for-date" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600">
                </div>
                <div class="flex gap-2 mt-8 w-full">
                    <button id="back-to-select-inv-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Atrás</button>
                    <button id="start-ordering-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Siguiente</button>
                </div>
            </div>

            <div id="order-method-view" class="view hidden absolute inset-0 flex flex-col h-full items-center justify-center text-center">
                <h1 class="text-3xl font-bold mb-8">¿Cómo quieres hacer el pedido?</h1>
                <div class="w-full space-y-4">
                     <button id="order-method-manual-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Ingresar Manualmente</button>
                     <button id="order-method-remito-btn" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-4 rounded-lg">Cargar desde Remito</button>
                </div>
                 <button id="back-to-setup-order-btn" class="mt-8 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Atrás</button>
            </div>
            
            <div id="remito-upload-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-order-method-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-xl font-bold text-center text-gray-100">Cargar Remito</h1>
                    <div class="w-8"></div>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center text-center p-4 border-2 border-dashed border-gray-600 rounded-lg bg-gray-900/50">
                    <label for="remito-upload-creation" class="cursor-pointer w-full h-full flex flex-col items-center justify-center">
                        <p class="text-gray-400">Selecciona fotos o un PDF del remito</p>
                        <input type="file" id="remito-upload-creation" accept="image/*,application/pdf" class="hidden" multiple>
                        <div id="remito-preview-container" class="mt-4 flex flex-wrap gap-2 justify-center max-h-48 overflow-y-auto"></div>
                    </label>
                </div>
                <button id="analyze-creation-remito-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Analizar Remito</button>
                <div id="processing-creation-loader" class="hidden text-center mt-2 text-sm text-blue-400">Procesando archivos...</div>
            </div>

            <div id="remito-confirm-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                   <button id="back-to-remito-upload-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                   <h1 class="text-xl font-bold text-center text-gray-100">Confirmar Cantidades</h1>
                   <div class="w-8"></div>
                </div>
                <p class="text-sm text-gray-400 mb-4 text-center">Ajusta, agrega o elimina ítems del remito.</p>
                
                <div class="mb-4 p-3 bg-gray-900/50 rounded-lg space-y-2">
                    <h3 class="text-md font-semibold mb-2 text-gray-300">Agregar Ítem Manualmente</h3>
                    <select id="add-remito-item-select" class="w-full bg-gray-700 text-white p-2 rounded-lg border-2 border-gray-600"></select>
                    <div class="flex gap-2">
                        <input type="number" id="add-remito-item-quantity" placeholder="Cantidad" class="flex-grow bg-gray-700 text-white p-2 rounded-lg border-2 border-gray-600">
                        <button id="add-remito-item-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold px-5 rounded-lg">Agregar</button>
                    </div>
                </div>

                <div id="remito-confirm-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                
                <div id="remito-summary-footer" class="sticky-footer p-4 mt-4 border-t border-gray-600 rounded-b-lg">
                    <div class="flex justify-between items-center text-lg">
                        <p class="text-gray-300">Ítems: <span id="remito-item-count" class="font-bold text-white">0</span></p>
                        <p class="text-gray-300">Bultos Totales: <span id="remito-bulto-count" class="font-bold text-white">0</span></p>
                    </div>
                     <button id="confirm-remito-data-btn" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Confirmar y Crear Pedido</button>
                </div>
            </div>

            <div id="order-item-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex-grow flex flex-col items-center justify-center text-center">
                    <p id="order-item-counter" class="text-sm font-medium text-blue-400 mb-2">Ítem 1/123</p>
                    <h1 id="order-item-name" class="text-3xl font-bold mb-4 text-gray-100">Nombre del Ítem</h1>
                    <div class="flex items-center justify-center gap-4 w-full mb-6">
                        <div class="text-center">
                            <label class="block text-sm font-medium text-gray-400">Stock Actual</label>
                            <div id="order-item-stock" class="bg-gray-700 text-white text-2xl p-4 rounded-lg w-32">0</div>
                        </div>
                        <div id="order-item-already-ordered-container" class="text-center hidden">
                            <label class="block text-sm font-medium text-gray-400">Ya Pedido</label>
                            <div id="order-item-already-ordered" class="bg-yellow-700 text-white text-2xl p-4 rounded-lg w-32">0</div>
                        </div>
                        <div class="text-center">
                            <label class="block text-sm font-medium text-gray-400">Cantidad a Pedir</label>
                            <input type="number" step="0.01" id="order-item-quantity" placeholder="Pedir" class="bg-gray-600 text-white text-center text-2xl p-4 rounded-lg border-2 border-gray-500 w-32">
                        </div>
                    </div>
                </div>
                <div class="mt-auto grid grid-cols-3 gap-2">
                    <button id="order-no-pedir-btn" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-2 rounded-lg text-sm">No Pedir</button>
                    <button id="order-skip-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-2 rounded-lg text-sm">Saltar</button>
                    <button id="order-next-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-2 rounded-lg text-sm">Siguiente</button>
                </div>
            </div>

            <div id="order-summary-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-order-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 id="order-summary-title" class="text-xl font-bold text-center text-gray-100">Resumen de Pedido</h1>
                    <div class="w-8"></div>
                </div>
                 <input type="search" id="order-summary-search" placeholder="Buscar ítem..." class="w-full bg-gray-700 p-2 rounded-lg mb-4 border-2 border-gray-600">
                <div id="order-summary-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
            </div>

            <div id="edit-order-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-history-from-edit-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 id="edit-order-title" class="text-xl font-bold text-center text-gray-100">Editar Pedido</h1>
                    <div class="w-8"></div>
                </div>
                <div id="edit-order-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                <button id="save-edited-order-btn" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Guardar Cambios</button>
            </div>

            <div id="edit-inventory-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-history-from-edit-inv-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 id="edit-inventory-title" class="text-xl font-bold text-center text-gray-100">Editar Inventario</h1>
                    <div class="w-8"></div>
                </div>
                <div id="edit-inventory-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                <button id="save-edited-inventory-btn" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Guardar Cambios</button>
            </div>

            <div id="setup-view" class="view hidden absolute inset-0 flex flex-col h-full items-center justify-center text-center">
                <h1 class="text-3xl font-bold mb-8">Detalles del Conteo</h1>
                <div class="w-full space-y-4">
                    <input type="date" id="inventory-date" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600">
                    <select id="inventory-time" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600">
                        <option>Apertura</option> <option>Intermedio</option> <option>Cierre</option>
                    </select>
                </div>
                <button id="start-counting-btn" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Comenzar</button>
            </div>

            <div id="item-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex-grow flex flex-col items-center justify-center text-center">
                    <p id="item-counter" class="text-sm font-medium text-indigo-400 mb-2">Ítem 1/123</p>
                    <h1 id="item-name" class="text-3xl font-bold mb-6 text-gray-100">Nombre del Ítem</h1>
                    <input type="number" step="0.01" id="item-quantity" placeholder="Ingresa la cantidad" class="w-full bg-gray-700 text-white text-center text-2xl p-4 rounded-lg border-2 border-gray-600">
                </div>
                <div class="mt-auto grid grid-cols-3 gap-2">
                    <button id="na-btn" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-2 rounded-lg text-sm">N/A</button>
                    <button id="skip-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-2 rounded-lg text-sm">Saltar</button>
                    <button id="next-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-2 rounded-lg text-sm">Siguiente</button>
                </div>
            </div>

            <div id="summary-view" class="view hidden absolute inset-0 flex flex-col h-full">
                <div class="flex items-center justify-between mb-4">
                    <button id="back-to-count-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-2xl font-bold text-center text-gray-100">Resumen</h1>
                    <div class="w-8"></div>
                </div>
                <input type="search" id="inventory-summary-search" placeholder="Buscar ítem..." class="w-full bg-gray-700 p-2 rounded-lg mb-4 border-2 border-gray-600">
                <div id="summary-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
            </div>

            <div id="history-view" class="view hidden absolute inset-0 flex flex-col h-full">
                 <div class="flex items-center justify-between mb-4">
                    <button id="back-to-menu-from-history-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-2xl font-bold text-center text-gray-100">Historial</h1>
                    <div class="w-8"></div>
                </div>
                <div id="history-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
            </div>

            <div id="history-detail-view" class="view hidden absolute inset-0 flex flex-col h-full">
                 <div class="flex items-center justify-between mb-4">
                    <button id="back-to-history-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 id="history-detail-title" class="text-xl font-bold text-center text-gray-100">Detalle</h1>
                    <button id="history-detail-pdf-btn" class="bg-indigo-600 px-3 py-1 rounded-lg text-sm">PDF</button>
                </div>
                <div id="history-detail-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
            </div>

            <div id="manage-items-view" class="view hidden absolute inset-0 flex flex-col h-full">
                 <div class="flex items-center justify-between mb-4">
                    <button id="back-to-menu-from-manage-btn" class="bg-gray-700 p-2 rounded-full hover:bg-gray-600">&larr;</button>
                    <h1 class="text-2xl font-bold text-center text-gray-100">Gestionar Ítems</h1>
                    <div class="w-8"></div>
                </div>
                 <input type="search" id="manage-items-search" placeholder="Buscar ítem..." class="w-full bg-gray-700 p-2 rounded-lg mb-4 border-2 border-gray-600">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-item-name" placeholder="Nombre del nuevo ítem" class="flex-grow bg-gray-700 p-2 rounded-lg border-2 border-gray-600">
                    <button id="add-item-btn" class="bg-green-600 px-4 rounded-lg font-bold">+</button>
                </div>
                <div id="manage-items-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
                <button id="save-item-order-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Guardar Orden</button>
            </div>

            <div id="finished-view" class="view hidden absolute inset-0 flex-col h-full items-center justify-center text-center">
                 <h1 class="text-3xl font-bold mb-4 text-green-400">¡Inventario Completo!</h1>
                 <p class="text-gray-300 mb-6">Conteo finalizado. Puedes guardarlo o descargarlo.</p>
                 <div class="w-full space-y-4">
                    <button id="save-and-finish-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Guardar y Finalizar</button>
                    <button id="final-download-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">Descargar PDF</button>
                 </div>
            </div>

            <div id="order-finished-view" class="view hidden absolute inset-0 flex-col h-full items-center justify-center text-center">
                 <h1 class="text-3xl font-bold mb-4 text-blue-400">¡Pedido Completo!</h1>
                 <p class="text-gray-300 mb-6">Has ingresado todos los ítems del pedido.</p>
                 <div class="w-full space-y-4">
                    <button id="save-order-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Guardar Pedido</button>
                    <button id="order-finished-download-pdf-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Descargar PDF</button>
                 </div>
            </div>
        </div>
        
        <div id="nav-buttons" class="mt-6 flex justify-center space-x-2" style="display: none;">
            <button id="discard-progress-btn" class="bg-red-800 hover:bg-red-700 text-sm text-white font-bold py-2 px-4 rounded-lg">Descartar</button>
            <button data-context="inventory" id="summary-btn" class="bg-gray-700 hover:bg-gray-600 text-sm text-gray-300 font-medium py-2 px-4 rounded-lg">Resumen</button>
            <button data-context="inventory" id="download-pdf-btn" class="bg-gray-700 hover:bg-gray-600 text-sm text-gray-300 font-medium py-2 px-4 rounded-lg">PDF</button>
            <button id="save-and-exit-btn" class="bg-indigo-800 hover:bg-indigo-700 text-sm text-white font-bold py-2 px-4 rounded-lg">Guardar y Salir</button>
        </div>
    </div>
    
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50"></div>

    <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg p-6 text-center shadow-xl">
            <h3 id="confirm-delete-title" class="text-lg font-bold text-white mb-2">¿Estás seguro?</h3>
            <p id="confirm-delete-message" class="text-gray-300 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, writeBatch, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7MrPbY7cwywvOnyz_-5RXFO1S40Z6Ous",
            authDomain: "mi-app-inventario-e639f.firebaseapp.com",
            projectId: "mi-app-inventario-e639f",
            storageBucket: "mi-app-inventario-e639f.appspot.com",
            messagingSenderId: "97971834944",
            appId: "1:97971834944:web:604dbbc1cf96964fcd4fa5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const initialItemsList = ["ACEITE FRITURA", "ALMIBAR PARA FACTURA X 7 KG", "AZUCAR INDIVIDUAL KFC", "BANDEJA CANOA KFC", "BOLSA DE LLEVAR GRANDE KFC2", "BOLSA DE RESIDUOS CHICA", "BOLSA DE RESIDUOS NEGRA X 250 UND", "BOLSA DE RESIDUOS TRANSPARENTE", "BOLSA PARA MARINADO K EN ROLLOS", "BOLSA SIN MANIJA GRANDE KFC X 250 UND", "BUCKET 130OZ KFC X 300UN", "BUCKET 50OZ X 420 UND", "BUCKET 85OZ X 330 UND", "CAFE EN POLVO", "CAJA BIG BOXKFC", "CAJA SNACK CON TAPA KFC X 800 UND", "CANDADITOS KFC", "CHOCOLATE CON MANI X 4.32KG", "CHOCOLATE EN POLVO X 4KG", "CINTA DE SEGURIDAD KFC X 36 UND", "COFIA DE FISELINA DESCARTABLE", "CONO HELADO", "CUCHARITA PARA HELADO X 1000 UND", "CUCHILLO", "EDULCORANTE INDIVIDUAL KFC", "ESTUCHE PAPA CHICA KFC X 800 UND", "ESTUCHE PAPAS GRANDES KFC", "ESTUCHE PAPAS MEDIANAS KFC", "ESTUCHE POPCORN GRANDE", "ESTUCHE POPCORN MEDIANO", "ETC TEMPERO", "FILTRO FREIDORAS FRYMASTER", "FILTRO FREIDORAS HENNY PENNY", "GALLETITA OREO CAJA X36 X 117 GR", "GUANTES VINILO M", "HARINA X 11.389KG", "JUGO DE LIMON INDIVIDUAL", "KETCHUP INDIVIDUAL", "LAMINA ANTIGRASA SANDWICH KFC X1500", "LECHE EN POLVO CAJAX10KG", "MANTECOL", "MANTELITO KFC", "MAYONESA INDIVIDUAL", "MEZCLA HUEVO/LECHE", "MOSTAZA CON MIEL", "MOSTAZA CON MIEL INDIVIDUAL", "MOSTAZA INDIVIDUAL", "PAÑO BLANCO X 300 UN", "PAÑO AZUL", "PAÑO ROJO", "PAPEL ANTIGRASA BLANCO", "PAPEL ANTIGRASA GENERICO CAJA X 4000", "PAPEL ANTIGRASA SANDWICH KFC 2", "PAPEL DE MANOS (TO)", "PAPEL FILM (ROLLO)", "PAPEL HIGIENICO", "PAPEL SILICONADO X 500 UND", "PORTAVASOS KFC X 200 UND", "REVOLVEDOR CAFE MADERA", "ROLLO IMPRESORA FISCAL GENERICO 2", "SAL A GRANEL", "SAL SOBRE INDIVIDUAL KFC", "SALSA BARBACOA A GRANEL", "SALSA BARBACOA INDIVIDUAL", "SALSA PICANTE A GRANEL", "SALSA PICANTE INDIVIDUAL", "SEASONING OR", "SERVILLETAS 30X30 X 5000 UND", "SERVILletas PARA CONO", "SOBRE KFC X 1000 UND", "STICKER REDONDO AMARILLO", "STICKER REDONDO AZUL", "STICKER REDONDO NARANJA", "STICKER REDONDO NEGRO", "STICKER REDONDO ROJO", "STICKER REDONDO VERDE", "STICKER VENCIMIENTO", "SUNDAE KFC 7.25 OZ X 2000 UND", "TAPA BUCKET KFC X 2150 UND", "TAPA CAJA BIG BOX", "TAPA DIPPER", "TAPA VASO CAFE 8 Y 12 OZ X 2000 UND", "TAPA VASO GASEOSA 16OZ", "TAPA VASO GASEOSA 12OZ", "TE INTIZEN ILUMINE (ROJO)", "TENEDOR", "QUESO CHEDDAR EN POLVO", "VASO AVALANCHA KFC X 1200 UND", "VASO CAFE 8 OZ KFC", "VASO CORTESIA KFC", "VASO GASEOSA 12OZ KFC A", "VASO GASEOSA 16OZ KFC A", "VASO GASEOSA 21OZ KFC", "VASO CAFE 12 OZ KFC X 1000", "HELADO DULCE DE LECHE", "HELADO VAINILLA", "JARABE DE FRUTILLA", "SALSA DE CHOCOLATE", "SALSA DE DULCE DE LECHE X 5KG", "QUESO CHEDDAR EN FETAS 2", "LOMITO EN FETAS", "PANCETA KFC", "MANTECA X 6KG", "MAYONESA A GRANEL", "MIXDE ENSALADA", "TOMATE", "PAN PORTENO", "PANAL MEMBRILLO X 72 UND", "REJILLA PASTELERA X 72 UND", "MEDIALUNA DE GRASA X 240 UND", "MEDIALUNA DE MANTECA X 180 UND", "HELADO CONG SUNDAE CHOC", "HELADO CONGELADO SUNDAE DDL", "HELADO CONGELADO AVALANCHA KFC", "PAPAS FRITAS KFC C7 X 18 KG", "AROS DE CEBOLLA X 10KG"];
        
        let state = {
            currentInventory: null,
            currentOrder: null,
            history: [],
            masterItems: [],
            consumptionResults: [],
            consumptionComparison: null,
            consumptionMode: 'single'
        };
        let itemsToCountQueue = [];
        let positionInQueue = -1;
        let currentIndex = 0;
        let appMode = 'inventory';
        let tempBaseInventoryId = null;
        let editingId = null;
        let userId = null;
        let unsubscribe = {};
        let isLoginMode = true;
        let tempRemitoItems = [];
        let draggedItemIndex = null;

        document.addEventListener('DOMContentLoaded', () => {
            const allViews = document.querySelectorAll('.view');
            const navButtons = document.getElementById('nav-buttons');
            const el = {
                loadingView: document.getElementById('loading-view'),
                loginView: document.getElementById('login-view'),
                mainContent: document.getElementById('main-content'),
                mainMenu: document.getElementById('main-menu-view'),
                setup: document.getElementById('setup-view'),
                item: document.getElementById('item-view'),
                summary: document.getElementById('summary-view'),
                history: document.getElementById('history-view'),
                historyDetail: document.getElementById('history-detail-view'),
                manageItems: document.getElementById('manage-items-view'),
                finished: document.getElementById('finished-view'),
                orderFinished: document.getElementById('order-finished-view'),
                selectInventory: document.getElementById('select-inventory-view'),
                setupOrder: document.getElementById('setup-order-view'),
                orderItem: document.getElementById('order-item-view'),
                orderSummary: document.getElementById('order-summary-view'),
                editOrder: document.getElementById('edit-order-view'),
                editInventory: document.getElementById('edit-inventory-view'),
                consumptionSetup: document.getElementById('consumption-setup-view'),
                consumptionResult: document.getElementById('consumption-result-view'),
                continueInventoryBtn: document.getElementById('continue-inventory-btn'),
                continueOrderBtn: document.getElementById('continue-order-btn'),
                startNewInventoryBtn: document.getElementById('start-new-inventory-btn'),
                makeOrderBtn: document.getElementById('make-order-btn'),
                consumptionReportBtn: document.getElementById('consumption-report-btn'),
                historyBtn: document.getElementById('history-btn'),
                manageItemsBtn: document.getElementById('manage-items-btn'),
                inventoryDate: document.getElementById('inventory-date'),
                inventoryTime: document.getElementById('inventory-time'),
                startCountingBtn: document.getElementById('start-counting-btn'),
                itemCounter: document.getElementById('item-counter'),
                itemName: document.getElementById('item-name'),
                itemQuantity: document.getElementById('item-quantity'),
                naBtn: document.getElementById('na-btn'),
                skipBtn: document.getElementById('skip-btn'),
                nextBtn: document.getElementById('next-btn'),
                summaryList: document.getElementById('summary-list'),
                inventorySummarySearch: document.getElementById('inventory-summary-search'),
                backToCountBtn: document.getElementById('back-to-count-btn'),
                historyList: document.getElementById('history-list'),
                backToMenuFromHistoryBtn: document.getElementById('back-to-menu-from-history-btn'),
                historyDetailTitle: document.getElementById('history-detail-title'),
                historyDetailList: document.getElementById('history-detail-list'),
                historyDetailPdfBtn: document.getElementById('history-detail-pdf-btn'),
                backToHistoryBtn: document.getElementById('back-to-history-btn'),
                manageItemsList: document.getElementById('manage-items-list'),
                manageItemsSearch: document.getElementById('manage-items-search'),
                newItemName: document.getElementById('new-item-name'),
                addItemBtn: document.getElementById('add-item-btn'),
                backToMenuFromManageBtn: document.getElementById('back-to-menu-from-manage-btn'),
                saveAndFinishBtn: document.getElementById('save-and-finish-btn'),
                finalDownloadBtn: document.getElementById('final-download-btn'),
                saveOrderBtn: document.getElementById('save-order-btn'),
                orderFinishedDownloadPdfBtn: document.getElementById('order-finished-download-pdf-btn'),
                globalSummaryBtn: document.getElementById('summary-btn'),
                globalPdfBtn: document.getElementById('download-pdf-btn'),
                saveAndExitBtn: document.getElementById('save-and-exit-btn'),
                discardProgressBtn: document.getElementById('discard-progress-btn'),
                saveItemOrderBtn: document.getElementById('save-item-order-btn'),
                toast: document.getElementById('toast-notification'),
                confirmDeleteModal: document.getElementById('confirm-delete-modal'),
                confirmDeleteTitle: document.getElementById('confirm-delete-title'),
                confirmDeleteMessage: document.getElementById('confirm-delete-message'),
                cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                selectInventoryList: document.getElementById('select-inventory-list'),
                backToMenuFromSelectInvBtn: document.getElementById('back-to-menu-from-select-inv-btn'),
                orderForDate: document.getElementById('order-for-date'),
                backToSelectInvBtn: document.getElementById('back-to-select-inv-btn'),
                startOrderingBtn: document.getElementById('start-ordering-btn'),
                orderItemCounter: document.getElementById('order-item-counter'),
                orderItemName: document.getElementById('order-item-name'),
                orderItemStock: document.getElementById('order-item-stock'),
                orderItemQuantity: document.getElementById('order-item-quantity'),
                orderItemAlreadyOrderedContainer: document.getElementById('order-item-already-ordered-container'),
                orderItemAlreadyOrdered: document.getElementById('order-item-already-ordered'),
                orderNoPedirBtn: document.getElementById('order-no-pedir-btn'),
                orderSkipBtn: document.getElementById('order-skip-btn'),
                orderNextBtn: document.getElementById('order-next-btn'),
                orderSummaryTitle: document.getElementById('order-summary-title'),
                orderSummaryList: document.getElementById('order-summary-list'),
                orderSummarySearch: document.getElementById('order-summary-search'),
                backToOrderBtn: document.getElementById('back-to-order-btn'),
                editOrderTitle: document.getElementById('edit-order-title'),
                editOrderList: document.getElementById('edit-order-list'),
                backToHistoryFromEditBtn: document.getElementById('back-to-history-from-edit-btn'),
                saveEditedOrderBtn: document.getElementById('save-edited-order-btn'),
                editInventoryTitle: document.getElementById('edit-inventory-title'),
                editInventoryList: document.getElementById('edit-inventory-list'),
                backToHistoryFromEditInvBtn: document.getElementById('back-to-history-from-edit-inv-btn'),
                saveEditedInventoryBtn: document.getElementById('save-edited-inventory-btn'),
                backToMenuFromConsumptionBtn: document.getElementById('back-to-menu-from-consumption-btn'),
                startInventorySelect: document.getElementById('start-inventory-select'),
                endInventorySelect: document.getElementById('end-inventory-select'),
                generateConsumptionReportBtn: document.getElementById('generate-consumption-report-btn'),
                startComparisonBtn: document.getElementById('start-comparison-btn'),
                comparisonContainer: document.getElementById('comparison-container'),
                startInventorySelect2: document.getElementById('start-inventory-select-2'),
                endInventorySelect2: document.getElementById('end-inventory-select-2'),
                generateComparisonBtn: document.getElementById('generate-comparison-btn'),
                consumptionSearch: document.getElementById('consumption-search'),
                consumptionResultList: document.getElementById('consumption-result-list'),
                backToConsumptionSetupBtn: document.getElementById('back-to-consumption-setup-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                userEmail: document.getElementById('user-email'),
                loginError: document.getElementById('login-error-message'),
                authTitle: document.getElementById('auth-title'),
                emailInput: document.getElementById('email-input'),
                passwordInput: document.getElementById('password-input'),
                authActionBtn: document.getElementById('auth-action-btn'),
                authToggleText: document.getElementById('auth-toggle-text'),
                authToggleBtn: document.getElementById('auth-toggle-btn'),
                orderMethodView: document.getElementById('order-method-view'),
                orderMethodManualBtn: document.getElementById('order-method-manual-btn'),
                orderMethodRemitoBtn: document.getElementById('order-method-remito-btn'),
                backToSetupOrderBtn: document.getElementById('back-to-setup-order-btn'),
                remitoUploadView: document.getElementById('remito-upload-view'),
                backToOrderMethodBtn: document.getElementById('back-to-order-method-btn'),
                remitoUploadCreation: document.getElementById('remito-upload-creation'),
                remitoPreviewContainer: document.getElementById('remito-preview-container'),
                analyzeCreationRemitoBtn: document.getElementById('analyze-creation-remito-btn'),
                processingCreationLoader: document.getElementById('processing-creation-loader'),
                remitoConfirmView: document.getElementById('remito-confirm-view'),
                backToRemitoUploadBtn: document.getElementById('back-to-remito-upload-btn'),
                remitoConfirmList: document.getElementById('remito-confirm-list'),
                confirmRemitoDataBtn: document.getElementById('confirm-remito-data-btn'),
                addRemitoItemSelect: document.getElementById('add-remito-item-select'),
                addRemitoItemQuantity: document.getElementById('add-remito-item-quantity'),
                addRemitoItemBtn: document.getElementById('add-remito-item-btn'),
                remitoItemCount: document.getElementById('remito-item-count'),
                remitoBultoCount: document.getElementById('remito-bulto-count'),
            };

            const refs = {
                masterItems: () => doc(db, 'users', userId, 'data', 'masterItems'),
                currentInventory: () => doc(db, 'users', userId, 'data', 'currentInventory'),
                currentOrder: () => doc(db, 'users', userId, 'data', 'currentOrder'),
                history: () => collection(db, 'users', userId, 'history'),
                historyDoc: (id) => doc(db, 'users', userId, 'history', String(id))
            };

            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    el.userEmail.textContent = user.email || 'Usuario Anónimo';
                    Object.values(unsubscribe).forEach(unsub => unsub());
                    
                    unsubscribe.masterItems = onSnapshot(refs.masterItems(), (docSnap) => {
                        if (docSnap.exists() && docSnap.data().items) {
                            state.masterItems = docSnap.data().items;
                        } else {
                            setDoc(refs.masterItems(), { items: initialItemsList });
                            state.masterItems = initialItemsList;
                        }
                    });

                    unsubscribe.currentInventory = onSnapshot(refs.currentInventory(), (docSnap) => {
                        state.currentInventory = docSnap.exists() ? docSnap.data() : null;
                        el.continueInventoryBtn.style.display = state.currentInventory ? 'block' : 'none';
                    });

                    unsubscribe.currentOrder = onSnapshot(refs.currentOrder(), (docSnap) => {
                        state.currentOrder = docSnap.exists() ? docSnap.data() : null;
                        el.continueOrderBtn.style.display = state.currentOrder ? 'block' : 'none';
                    });

                    const q = query(refs.history(), orderBy('date', 'desc'));
                    unsubscribe.history = onSnapshot(q, (querySnapshot) => {
                        state.history = [];
                        querySnapshot.forEach((doc) => {
                            state.history.push({ ...doc.data(), id: doc.id });
                        });
                    });

                    el.loadingView.classList.add('hidden');
                    el.loginView.classList.add('hidden');
                    el.mainContent.classList.remove('hidden');
                    switchView(el.mainMenu);

                } else {
                    userId = null;
                    Object.values(unsubscribe).forEach(unsub => unsub());
                    el.loadingView.classList.add('hidden');
                    el.mainContent.classList.add('hidden');
                    el.loginView.classList.remove('hidden');
                }
            });
            
            function switchView(viewToShow) {
                allViews.forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
                let showNav = false;
                if (appMode === 'inventory' && ([el.item, el.summary].includes(viewToShow))) {
                    showNav = true;
                } else if (appMode === 'order' && ([el.orderItem, el.orderSummary].includes(viewToShow))) {
                    showNav = true;
                }
                navButtons.style.display = showNav ? 'flex' : 'none';
                if(showNav){
                    el.globalSummaryBtn.dataset.context = appMode;
                    el.globalPdfBtn.dataset.context = appMode;
                }
            }

            function showToast(message) {
                el.toast.textContent = message;
                el.toast.classList.remove('hidden');
                setTimeout(() => el.toast.classList.add('hidden'), 3000);
            }

            function renderCurrentItem(mode) {
                const process = mode === 'order' ? state.currentOrder : state.currentInventory;
                if (currentIndex < 0 || !process || currentIndex >= process.items.length) return;
                const item = process.items[currentIndex];
                
                if (mode === 'order') {
                    el.orderItemName.textContent = item.name;
                    el.orderItemCounter.textContent = `Ítem ${positionInQueue + 1} de ${itemsToCountQueue.length}`;
                    el.orderItemStock.textContent = item.stock ?? 'N/A';
                    el.orderItemQuantity.value = (item.toOrder === null || item.toOrder === 'NO PEDIR') ? '' : item.toOrder;
                    el.orderItemQuantity.focus();

                    // Calculate and display "Already Ordered"
                    const newOrderDate = new Date(state.currentOrder.orderForDate);
                    const baseInventory = state.history.find(h => h.id === state.currentOrder.baseInventoryId);

                    let alreadyOrdered = 0;
                    if (baseInventory) {
                        const baseInventoryDate = new Date(baseInventory.date);

                        const previousOrders = state.history.filter(h =>
                            h.type === 'order' &&
                            h.baseInventoryId === state.currentOrder.baseInventoryId &&
                            new Date(h.orderForDate) < newOrderDate &&
                            new Date(h.orderForDate) > baseInventoryDate
                        );

                        previousOrders.forEach(order => {
                            const orderedItem = order.items.find(i => i.name === item.name);
                            if (orderedItem && typeof orderedItem.toOrder === 'number') {
                                alreadyOrdered += orderedItem.toOrder;
                            }
                        });
                    }

                    if (alreadyOrdered > 0) {
                        el.orderItemAlreadyOrdered.textContent = alreadyOrdered;
                        el.orderItemAlreadyOrderedContainer.classList.remove('hidden');
                    } else {
                        el.orderItemAlreadyOrderedContainer.classList.add('hidden');
                    }

                } else {
                    el.itemName.textContent = item.name;
                    el.itemCounter.textContent = `Ítem ${positionInQueue + 1} de ${itemsToCountQueue.length}`;
                    el.itemQuantity.value = (item.quantity === null || item.quantity === 'N/A') ? '' : item.quantity;
                    el.itemQuantity.focus();
                }
            }

            async function advanceToNextItem(mode) {
                positionInQueue++;
                const process = mode === 'order' ? state.currentOrder : state.currentInventory;
                const quantityKey = mode === 'order' ? 'toOrder' : 'quantity';

                if (positionInQueue >= itemsToCountQueue.length) {
                    const remainingIndices = process.items
                        .map((item, index) => ({ ...item, originalIndex: index }))
                        .filter(item => item[quantityKey] === null)
                        .map(item => item.originalIndex);

                    if (remainingIndices.length > 0) {
                        itemsToCountQueue = remainingIndices;
                        positionInQueue = 0;
                        currentIndex = itemsToCountQueue[0];
                        renderCurrentItem(mode);
                    } else {
                        if (mode === 'order') {
                            switchView(el.orderFinished);
                        } else {
                            switchView(el.finished);
                        }
                    }
                } else {
                    currentIndex = itemsToCountQueue[positionInQueue];
                    renderCurrentItem(mode);
                }
                await setDoc(mode === 'order' ? refs.currentOrder() : refs.currentInventory(), process);
            }

            function handleDownloadPdf(entry, type) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                if (!entry || !entry.items) return alert('No hay datos para generar el PDF.');

                if (type === 'order') {
                    const tableData = entry.items.filter(item => item.toOrder !== null && item.toOrder !== 'NO PEDIR').map(item => [item.name, item.stock, item.toOrder, item.received ?? item.toOrder]);
                    if (tableData.length === 0) return alert('No hay items en el pedido para generar el PDF.');
                    const orderForDate = new Date(entry.orderForDate);
                    orderForDate.setMinutes(orderForDate.getMinutes() + orderForDate.getTimezoneOffset());
                    doc.text(`Pedido para el día: ${orderForDate.toLocaleDateString('es-AR')}`, 14, 22);
                    doc.autoTable({ head: [['Ítem', 'Stock', 'Pedido', 'Recibido']], body: tableData, startY: 35 });
                } else {
                    const countedItems = entry.items.filter(item => item.quantity !== null);
                    if (countedItems.length === 0) return alert('No hay items con cantidad para generar el PDF.');
                    const tableData = countedItems.map(item => [item.name, item.quantity]);
                    const inventoryDate = new Date(entry.date);
                    inventoryDate.setMinutes(inventoryDate.getMinutes() + inventoryDate.getTimezoneOffset());
                    doc.text("Resumen de Inventario", 14, 22);
                    doc.text(`Fecha: ${inventoryDate.toLocaleDateString('es-AR')} - Momento: ${entry.timeOfDay}`, 14, 30);
                    doc.autoTable({ head: [['Ítem', 'Cantidad']], body: tableData, startY: 35 });
                }
                const dateStr = new Date().toISOString().split('T')[0];
                doc.save(`documento_${dateStr}.pdf`);
            }

            function renderSummaryList(searchTerm = '') {
                el.summaryList.innerHTML = '';
                if (!state.currentInventory || !state.currentInventory.items) return;
                
                const filteredItems = state.currentInventory.items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                filteredItems.forEach((item) => {
                    const index = state.currentInventory.items.indexOf(item);
                    const isNA = item.quantity === 'N/A';
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = `flex-1 mr-4 ${isNA ? 'text-gray-500 line-through' : 'text-gray-200'}`;
                    nameSpan.textContent = item.name;
                    listItem.appendChild(nameSpan);
                    const controlsWrapper = document.createElement('div');
                    controlsWrapper.className = 'flex items-center gap-2';
                    const itemInput = document.createElement('input');
                    itemInput.type = 'number';
                    itemInput.step = '0.01';
                    itemInput.value = (item.quantity === null || isNA) ? '' : item.quantity;
                    itemInput.placeholder = isNA ? 'N/A' : '---';
                    itemInput.disabled = isNA;
                    itemInput.className = 'w-24 bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500 disabled:bg-gray-800 disabled:cursor-not-allowed';
                    itemInput.dataset.index = index;
                    itemInput.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.index, 10);
                        const rawValue = e.target.value.replace(',', '.');
                        const quantity = rawValue !== '' ? parseFloat(rawValue) : null;
                        state.currentInventory.items[idx].quantity = (quantity !== null && !isNaN(quantity)) ? quantity : null;
                        setDoc(refs.currentInventory(), state.currentInventory);
                    });
                    controlsWrapper.appendChild(itemInput);
                    if (isNA) {
                        const undoBtn = document.createElement('button');
                        undoBtn.innerHTML = '&#8634;';
                        undoBtn.title = 'Deshacer N/A';
                        undoBtn.className = 'bg-blue-600 hover:bg-blue-500 text-white font-bold w-10 h-10 flex items-center justify-center rounded-lg';
                        undoBtn.dataset.index = index;
                        undoBtn.addEventListener('click', (e) => {
                            const idx = parseInt(e.currentTarget.dataset.index, 10);
                            state.currentInventory.items[idx].quantity = null;
                            setDoc(refs.currentInventory(), state.currentInventory);
                            renderSummaryList(el.inventorySummarySearch.value);
                        });
                        controlsWrapper.appendChild(undoBtn);
                    }
                    listItem.appendChild(controlsWrapper);
                    el.summaryList.appendChild(listItem);
                });
            }
            
            function renderHistoryList(forSelection) {
                const listElement = forSelection ? el.selectInventoryList : el.historyList;
                listElement.innerHTML = '';
                const inventories = state.history.filter(h => h.type === 'inventory').sort((a,b) => new Date(b.date) - new Date(a.date));

                if (inventories.length === 0) {
                    listElement.innerHTML = `<p class="text-gray-400 text-center">No hay ${forSelection ? 'inventarios' : 'registros'} guardados.</p>`;
                    return;
                }

                inventories.forEach((inv) => {
                    const details = document.createElement('details');
                    details.className = 'bg-gray-700 rounded-lg';
                    
                    const summary = document.createElement('summary');
                    summary.className = 'p-3 flex justify-between items-center cursor-pointer';
                    
                    const inventoryDate = new Date(inv.date);
                    inventoryDate.setMinutes(inventoryDate.getMinutes() + inventoryDate.getTimezoneOffset());
                    
                    const buttonsHTML = forSelection 
                        ? `<button data-id="${inv.id}" class="select-inv-btn bg-green-600 px-3 py-1 rounded-lg text-sm z-10">Seleccionar</button>`
                        : `<div class="flex gap-2 z-10">
                               <button data-id="${inv.id}" class="edit-inventory-btn bg-yellow-600 px-3 py-1 rounded-lg text-xs">Editar</button>
                               <button data-id="${inv.id}" class="delete-inventory-btn bg-red-600 px-3 py-1 rounded-lg text-xs">Borrar</button>
                           </div>`;

                    summary.innerHTML = `
                        <div>
                            <p class="font-bold">${inventoryDate.toLocaleDateString('es-AR')} <span class="text-sm font-normal text-indigo-400">(${inv.timeOfDay})</span></p>
                        </div>
                        ${buttonsHTML}
                    `;
                    details.appendChild(summary);

                    const ordersContainer = document.createElement('div');
                    ordersContainer.className = 'px-3 pb-3 border-t border-gray-600';
                    
                    const relatedOrders = state.history.filter(h => h.type === 'order' && String(h.baseInventoryId) === String(inv.id));

                    if (relatedOrders.length > 0) {
                        relatedOrders.forEach(order => {
                            const orderDate = new Date(order.orderForDate);
                            orderDate.setMinutes(orderDate.getMinutes() + orderDate.getTimezoneOffset());
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'mt-2 p-2 bg-gray-800 rounded-md flex justify-between items-center';
                            orderDiv.innerHTML = `
                                <p class="text-sm">Pedido para: <span class="font-semibold">${orderDate.toLocaleDateString('es-AR')}</span></p>
                                <div class="flex gap-2">
                                    <button data-id="${order.id}" class="history-details-btn bg-blue-600 px-3 py-1 rounded-lg text-xs">Ver</button>
                                    <button data-id="${order.id}" class="edit-order-btn bg-yellow-600 px-3 py-1 rounded-lg text-xs">Editar</button>
                                    <button data-id="${order.id}" class="delete-order-btn bg-red-600 px-3 py-1 rounded-lg text-xs">Borrar</button>
                                </div>
                            `;
                            ordersContainer.appendChild(orderDiv);
                        });
                    } else {
                        ordersContainer.innerHTML = '<p class="text-sm text-gray-400 mt-2">No hay pedidos para este inventario.</p>';
                    }
                    details.appendChild(ordersContainer);
                    listElement.appendChild(details);
                });

                listElement.querySelectorAll('.select-inv-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        tempBaseInventoryId = e.target.dataset.id;
                        if (tempBaseInventoryId) {
                            el.orderForDate.value = new Date().toISOString().split('T')[0];
                            switchView(el.setupOrder);
                        }
                    });
                });

                listElement.querySelectorAll('.history-details-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const entryIndex = state.history.findIndex(h => h.id == e.target.dataset.id);
                        if (entryIndex !== -1) {
                            renderHistoryDetailList(entryIndex);
                            switchView(el.historyDetail);
                        }
                    });
                });

                listElement.querySelectorAll('.edit-order-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        renderEditOrderView(e.target.dataset.id);
                    });
                });

                listElement.querySelectorAll('.edit-inventory-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        renderEditInventoryView(e.target.dataset.id);
                    });
                });

                listElement.querySelectorAll('.delete-inventory-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const invId = e.target.dataset.id;
                        el.confirmDeleteTitle.textContent = '¿Eliminar Inventario?';
                        el.confirmDeleteMessage.textContent = 'Se eliminará este inventario y todos sus pedidos asociados. Esta acción es irreversible.';
                        el.confirmDeleteModal.classList.remove('hidden');
                        el.confirmDeleteBtn.onclick = async () => {
                            const batch = writeBatch(db);
                            const relatedOrders = state.history.filter(h => String(h.baseInventoryId) === String(invId));
                            relatedOrders.forEach(order => batch.delete(refs.historyDoc(order.id)));
                            batch.delete(refs.historyDoc(invId));
                            await batch.commit();
                            
                            el.confirmDeleteModal.classList.add('hidden');
                            showToast('Inventario y pedidos asociados eliminados.');
                        };
                    });
                });
                
                listElement.querySelectorAll('.delete-order-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const orderId = e.target.dataset.id;
                        el.confirmDeleteTitle.textContent = '¿Eliminar Pedido?';
                        el.confirmDeleteMessage.textContent = 'Este pedido se eliminará permanentemente. Esta acción no se puede deshacer.';
                        el.confirmDeleteModal.classList.remove('hidden');
                        el.confirmDeleteBtn.onclick = async () => {
                            await deleteDoc(refs.historyDoc(orderId));
                            el.confirmDeleteModal.classList.add('hidden');
                            showToast('Pedido eliminado.');
                        };
                    });
                });
            }


            function renderHistoryDetailList(historyIndex) {
                const entry = state.history[historyIndex];
                if (!entry) return;
                const isOrder = entry.type === 'order';
                
                let title;
                if (isOrder) {
                    const baseInv = state.history.find(h => h.id === entry.baseInventoryId);
                    const baseDate = baseInv ? new Date(baseInv.date) : new Date();
                    if(baseInv) baseDate.setMinutes(baseDate.getMinutes() + baseDate.getTimezoneOffset());
                    const orderFor = new Date(entry.orderForDate);
                    orderFor.setMinutes(orderFor.getMinutes() + orderFor.getTimezoneOffset());
                    title = `Pedido para ${orderFor.toLocaleDateString('es-AR')} (Base: ${baseInv ? baseDate.toLocaleDateString('es-AR') : 'N/A'})`;
                } else {
                    const date = new Date(entry.date);
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    title = `${date.toLocaleDateString('es-AR')} - ${entry.timeOfDay}`;
                }
                el.historyDetailTitle.textContent = title;
                el.historyDetailList.innerHTML = '';

                let header;
                if (isOrder) {
                    header = `<div class="grid grid-cols-4 gap-2 font-bold text-gray-400 px-3 pb-2 border-b border-gray-600"><span>Ítem</span><span class="text-right">Stock</span><span class="text-right">Pedido</span><span class="text-right">Recibido</span></div>`;
                } else {
                    header = `<div class="grid grid-cols-2 gap-2 font-bold text-gray-400 px-3 pb-2 border-b border-gray-600"><span>Ítem</span><span class="text-right">Cantidad</span></div>`;
                }
                el.historyDetailList.innerHTML = header;

                entry.items.forEach(item => {
                    const quantity = isOrder ? item.toOrder : item.quantity;
                    if (quantity !== null && (!isOrder || (quantity !== 'NO PEDIR'))) {
                        const listItem = document.createElement('div');
                        if(isOrder) {
                            listItem.className = 'grid grid-cols-4 gap-2 bg-gray-700 p-3 rounded-lg';
                            listItem.innerHTML = `<span>${item.name}</span>
                                                  <span class="text-right font-semibold">${item.stock ?? 'N/A'}</span>
                                                  <span class="text-right font-semibold">${quantity}</span>
                                                  <span class="text-right font-semibold text-green-400">${item.received ?? quantity}</span>`;
                        } else {
                            listItem.className = 'grid grid-cols-2 gap-2 bg-gray-700 p-3 rounded-lg';
                            listItem.innerHTML = `<span>${item.name}</span><span class="text-right font-semibold">${quantity}</span>`;
                        }
                        el.historyDetailList.appendChild(listItem);
                    }
                });
                el.historyDetailPdfBtn.onclick = () => handleDownloadPdf(entry, isOrder ? 'order' : 'inventory');
            }
            
            function renderOrderSummaryList(searchTerm = '') {
                el.orderSummaryList.innerHTML = '';
                if (!state.currentOrder) return;

                const orderForDate = new Date(state.currentOrder.orderForDate);
                orderForDate.setMinutes(orderForDate.getMinutes() + orderForDate.getTimezoneOffset());
                el.orderSummaryTitle.textContent = `Pedido para: ${orderForDate.toLocaleDateString('es-AR')}`;

                const filteredItems = state.currentOrder.items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                filteredItems.forEach((item) => {
                    const index = state.currentOrder.items.indexOf(item);
                    const isNoPedir = item.toOrder === 'NO PEDIR';
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = `flex-1 mr-2 ${isNoPedir ? 'text-gray-500 line-through' : ''}`;
                    nameSpan.textContent = item.name;
                    listItem.appendChild(nameSpan);

                    const stockDiv = document.createElement('div');
                    stockDiv.className = 'text-center bg-gray-600 p-2 rounded-md w-20';
                    stockDiv.textContent = item.stock ?? 'N/A';
                    listItem.appendChild(stockDiv);

                    const controlsWrapper = document.createElement('div');
                    controlsWrapper.className = 'flex items-center gap-2 w-32 justify-end';

                    const itemInput = document.createElement('input');
                    itemInput.type = 'number';
                    itemInput.step = '0.01';
                    itemInput.value = (item.toOrder === null || isNoPedir) ? '' : item.toOrder;
                    itemInput.placeholder = isNoPedir ? 'NO PEDIR' : '---';
                    itemInput.disabled = isNoPedir;
                    itemInput.className = 'w-24 bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500 disabled:bg-gray-800';
                    itemInput.dataset.index = index;
                    itemInput.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.index, 10);
                        const rawValue = e.target.value.replace(',', '.');
                        const quantity = rawValue !== '' ? parseFloat(rawValue) : null;
                        state.currentOrder.items[idx].toOrder = (quantity !== null && !isNaN(quantity)) ? quantity : null;
                        setDoc(refs.currentOrder(), state.currentOrder);
                    });
                    controlsWrapper.appendChild(itemInput);

                    if (isNoPedir) {
                        const undoBtn = document.createElement('button');
                        undoBtn.innerHTML = '&#8634;';
                        undoBtn.title = 'Deshacer "No Pedir"';
                        undoBtn.className = 'bg-blue-600 hover:bg-blue-500 text-white font-bold w-10 h-10 flex items-center justify-center rounded-lg';
                        undoBtn.dataset.index = index;
                        undoBtn.addEventListener('click', (e) => {
                            const idx = parseInt(e.currentTarget.dataset.index, 10);
                            state.currentOrder.items[idx].toOrder = null;
                            setDoc(refs.currentOrder(), state.currentOrder);
                            renderOrderSummaryList(el.orderSummarySearch.value);
                        });
                        itemInput.remove();
                        controlsWrapper.appendChild(undoBtn);
                    }
                    listItem.appendChild(controlsWrapper);
                    el.orderSummaryList.appendChild(listItem);
                });
            }

            function renderEditOrderView(orderId) {
                editingId = orderId;
                const order = state.history.find(h => h.id == orderId);
                if (!order) return;

                const orderForDate = new Date(order.orderForDate);
                orderForDate.setMinutes(orderForDate.getMinutes() + orderForDate.getTimezoneOffset());
                el.editOrderTitle.textContent = `Editar Pedido para: ${orderForDate.toLocaleDateString('es-AR')}`;
                el.editOrderList.innerHTML = '';

                const header = `<div class="grid grid-cols-3 gap-2 font-bold text-gray-400 px-3 pb-2 border-b border-gray-600"><span>Ítem</span><span class="text-right">Pedido</span><span class="text-right">Recibido</span></div>`;
                el.editOrderList.innerHTML = header;

                order.items.forEach((item, index) => {
                    if (item.toOrder !== null && item.toOrder !== 'NO PEDIR') {
                        const listItem = document.createElement('div');
                        listItem.className = 'grid grid-cols-3 gap-2 items-center bg-gray-700 p-3 rounded-lg';
                        listItem.innerHTML = `
                            <span>${item.name}</span>
                            <div class="text-right bg-gray-600 p-2 rounded-md">${item.toOrder}</div>
                            <input type="number" step="0.01" value="${item.received ?? item.toOrder}" data-index="${index}" class="w-full bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500">
                        `;
                        el.editOrderList.appendChild(listItem);
                    }
                });
                switchView(el.editOrder);
            }

            function renderEditInventoryView(invId) {
                editingId = invId;
                const inv = state.history.find(h => h.id == invId);
                if (!inv) return;

                const invDate = new Date(inv.date);
                invDate.setMinutes(invDate.getMinutes() + invDate.getTimezoneOffset());
                el.editInventoryTitle.textContent = `Editar: ${invDate.toLocaleDateString('es-AR')} (${inv.timeOfDay})`;
                el.editInventoryList.innerHTML = '';

                inv.items.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    listItem.innerHTML = `
                        <span class="flex-1 mr-4">${item.name}</span>
                        <input type="number" step="0.01" value="${item.quantity ?? ''}" placeholder="${item.quantity === 'N/A' ? 'N/A' : '---'}" data-index="${index}" class="w-24 bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500">
                    `;
                    el.editInventoryList.appendChild(listItem);
                });
                switchView(el.editInventory);
            }
            
            function renderManageItemsList(searchTerm = '') {
                el.manageItemsList.innerHTML = '';
                const filteredItems = state.masterItems.filter(name => 
                    name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                filteredItems.forEach((name, index) => {
                    const originalIndex = state.masterItems.indexOf(name);
                    const listItem = document.createElement('div');
                    listItem.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center gap-2';
                    listItem.setAttribute('draggable', true);
                    listItem.dataset.index = originalIndex;

                    const dragHandle = `<span class="drag-handle text-gray-400 cursor-grab">&#x2630;</span>`;
                    
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex-grow';
                    nameContainer.innerHTML = `<span class="item-name-text">${name}</span>
                                               <input type="text" class="item-name-input hidden w-full bg-gray-600 p-1 rounded-md" value="${name}">`;

                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'flex gap-2';
                    buttonsContainer.innerHTML = `<button data-index="${originalIndex}" class="edit-item-btn bg-yellow-600 px-3 py-1 rounded-lg text-xs">Editar</button>
                                                  <button data-index="${originalIndex}" class="save-item-btn hidden bg-green-600 px-3 py-1 rounded-lg text-xs">Guardar</button>
                                                  <button data-index="${originalIndex}" class="delete-item-btn bg-red-600 px-3 py-1 rounded-lg text-xs font-bold">&times;</button>`;
                    
                    listItem.innerHTML = dragHandle;
                    listItem.appendChild(nameContainer);
                    listItem.appendChild(buttonsContainer);
                    el.manageItemsList.appendChild(listItem);
                });

                el.manageItemsList.querySelectorAll('.edit-item-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const listItem = e.target.closest('div');
                        listItem.querySelector('.item-name-text').classList.add('hidden');
                        listItem.querySelector('.item-name-input').classList.remove('hidden');
                        listItem.querySelector('.edit-item-btn').classList.add('hidden');
                        listItem.querySelector('.save-item-btn').classList.remove('hidden');
                    });
                });

                el.manageItemsList.querySelectorAll('.save-item-btn').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        const index = parseInt(e.target.dataset.index, 10);
                        const oldName = state.masterItems[index];
                        const listItem = e.target.closest('div');
                        const newName = listItem.querySelector('.item-name-input').value.trim().toUpperCase();

                        if (newName && newName !== oldName) {
                            state.masterItems[index] = newName;
                            await setDoc(refs.masterItems(), { items: state.masterItems });
                            showToast('Ítem renombrado.');
                        }
                        renderManageItemsList(el.manageItemsSearch.value);
                    });
                });

                el.manageItemsList.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', async e => {
                        if (confirm('¿Seguro que quieres eliminar este ítem?')) {
                            const index = parseInt(e.target.dataset.index, 10);
                            state.masterItems.splice(index, 1);
                            await setDoc(refs.masterItems(), { items: state.masterItems });
                            showToast('Ítem eliminado.');
                            renderManageItemsList(el.manageItemsSearch.value);
                        }
                    });
                });

                el.manageItemsList.querySelectorAll('[draggable="true"]').forEach(item => {
                    item.addEventListener('dragstart', e => {
                        draggedItemIndex = parseInt(e.currentTarget.dataset.index, 10);
                        e.currentTarget.classList.add('dragging');
                    });
                    item.addEventListener('dragend', e => {
                        e.currentTarget.classList.remove('dragging');
                        draggedItemIndex = null;
                        el.manageItemsList.querySelectorAll('.drag-over').forEach(i => i.classList.remove('drag-over'));
                    });
                    item.addEventListener('dragover', e => {
                        e.preventDefault();
                        el.manageItemsList.querySelectorAll('.drag-over').forEach(i => i.classList.remove('drag-over'));
                        e.currentTarget.classList.add('drag-over');
                    });
                    item.addEventListener('drop', e => {
                        e.preventDefault();
                        const droppedOnItemIndex = parseInt(e.currentTarget.dataset.index, 10);
                        if (draggedItemIndex !== null && draggedItemIndex !== droppedOnItemIndex) {
                            const [draggedItem] = state.masterItems.splice(draggedItemIndex, 1);
                            state.masterItems.splice(droppedOnItemIndex, 0, draggedItem);
                            renderManageItemsList(el.manageItemsSearch.value);
                        }
                    });
                });
            }


            function renderConsumptionSetup() {
                const inventories = state.history.filter(h => h.type === 'inventory').sort((a,b) => new Date(a.date) - new Date(b.date));
                el.startInventorySelect.innerHTML = '';
                el.endInventorySelect.innerHTML = '';
                el.startInventorySelect2.innerHTML = '';
                el.endInventorySelect2.innerHTML = '';
                inventories.forEach(inv => {
                    const date = new Date(inv.date);
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    const option = `<option value="${inv.id}">${date.toLocaleDateString('es-AR')} - ${inv.timeOfDay}</option>`;
                    el.startInventorySelect.innerHTML += option;
                    el.endInventorySelect.innerHTML += option;
                    el.startInventorySelect2.innerHTML += option;
                    el.endInventorySelect2.innerHTML += option;
                });
                el.comparisonContainer.classList.add('hidden');
                el.generateComparisonBtn.classList.add('hidden');
                el.generateConsumptionReportBtn.classList.remove('hidden');
                el.startComparisonBtn.classList.remove('hidden');
                el.consumptionSearch.value = '';
                state.consumptionMode = 'single';
                switchView(el.consumptionSetup);
            }

            function computeConsumption(startId, endId) {
                const startInv = state.history.find(h => h.id == startId);
                const endInv = state.history.find(h => h.id == endId);

                if (!startInv || !endInv || new Date(startInv.date) >= new Date(endInv.date)) {
                    return null;
                }

                const startDate = new Date(startInv.date);
                const endDate = new Date(endInv.date);

                const receivedOrders = state.history.filter(h =>
                    h.type === 'order' &&
                    new Date(h.orderForDate) > startDate &&
                    new Date(h.orderForDate) <= endDate
                );

                const results = [];

                state.masterItems.forEach(itemName => {
                    const startItem = startInv.items.find(i => i.name === itemName);
                    const endItem = endInv.items.find(i => i.name === itemName);

                    const startStock = parseFloat(startItem?.quantity) || 0;
                    const endStock = parseFloat(endItem?.quantity) || 0;

                    let receivedStock = 0;
                    receivedOrders.forEach(order => {
                        const orderItem = order.items.find(i => i.name === itemName);
                        if (orderItem) {
                            const quantityToAdd = typeof orderItem.received === 'number' ? orderItem.received : (typeof orderItem.toOrder === 'number' ? orderItem.toOrder : 0);
                            receivedStock += quantityToAdd;
                        }
                    });

                    const consumption = (startStock + receivedStock) - endStock;

                    if (startStock > 0 || endStock > 0 || receivedStock > 0 || consumption !== 0) {
                        results.push({ name: itemName, startStock, receivedStock, endStock, consumption });
                    }
                });

                return results;
            }

            function renderConsumptionReport() {
                const startId = el.startInventorySelect.value;
                const endId = el.endInventorySelect.value;

                const results = computeConsumption(startId, endId);
                if (!results) {
                    alert('Asegúrate de seleccionar un inventario inicial y final válidos. La fecha inicial debe ser anterior a la final.');
                    return;
                }

                state.consumptionMode = 'single';
                state.consumptionResults = results;
                renderConsumptionResultList('');
                switchView(el.consumptionResult);
            }

            function renderConsumptionComparison() {
                const startId1 = el.startInventorySelect.value;
                const endId1 = el.endInventorySelect.value;
                const startId2 = el.startInventorySelect2.value;
                const endId2 = el.endInventorySelect2.value;

                const period1 = computeConsumption(startId1, endId1);
                const period2 = computeConsumption(startId2, endId2);

                if (!period1 || !period2) {
                    alert('Verifica que todos los rangos seleccionados sean válidos.');
                    return;
                }

                state.consumptionMode = 'comparison';
                state.consumptionComparison = { period1, period2 };
                renderConsumptionComparisonList('');
                switchView(el.consumptionResult);
            }

            function renderConsumptionResultList(searchTerm = '') {
                el.consumptionResultList.innerHTML = '';
                const header = `<div class="grid grid-cols-5 gap-2 font-bold text-gray-400 px-3 pb-2 border-b border-gray-600 text-sm sticky-header">
                                    <span class="col-span-2">Ítem</span>
                                    <span class="text-right">Inicial</span>
                                    <span class="text-right">Recibido</span>
                                    <span class="text-right">Final</span>
                                    <span class="text-right">Consumo</span>
                               </div>`;
                el.consumptionResultList.innerHTML = header;

                state.consumptionResults
                    .filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .forEach(item => {
                        const listItem = document.createElement('div');
                        listItem.className = 'grid grid-cols-5 gap-2 bg-gray-700 p-3 rounded-lg text-sm';
                        listItem.innerHTML = `<span class="col-span-2">${item.name}</span>
                                              <span class="text-right">${item.startStock}</span>
                                              <span class="text-right text-green-400">+${item.receivedStock}</span>
                                              <span class="text-right">${item.endStock}</span>
                                              <span class="text-right font-bold text-orange-400">${item.consumption.toFixed(2)}</span>`;
                        el.consumptionResultList.appendChild(listItem);
                    });
            }

            function renderConsumptionComparisonList(searchTerm = '') {
                el.consumptionResultList.innerHTML = '';
                const header = `<div class="grid gap-2 font-bold text-gray-400 px-3 pb-2 border-b border-gray-600 text-sm sticky-header" style="grid-template-columns: 2fr repeat(8, 1fr);">
                                    <span>Ítem</span>
                                    <span class="text-right">Ini 1</span>
                                    <span class="text-right">Rec 1</span>
                                    <span class="text-right">Fin 1</span>
                                    <span class="text-right">Cons 1</span>
                                    <span class="text-right">Ini 2</span>
                                    <span class="text-right">Rec 2</span>
                                    <span class="text-right">Fin 2</span>
                                    <span class="text-right">Cons 2</span>
                               </div>`;
                el.consumptionResultList.innerHTML = header;

                const allNames = Array.from(new Set([
                    ...state.consumptionComparison.period1.map(r => r.name),
                    ...state.consumptionComparison.period2.map(r => r.name)
                ])).filter(name => name.toLowerCase().includes(searchTerm.toLowerCase()));

                allNames.forEach(name => {
                    const item1 = state.consumptionComparison.period1.find(r => r.name === name) || { startStock: 0, receivedStock: 0, endStock: 0, consumption: 0 };
                    const item2 = state.consumptionComparison.period2.find(r => r.name === name) || { startStock: 0, receivedStock: 0, endStock: 0, consumption: 0 };
                    const listItem = document.createElement('div');
                    listItem.className = 'grid gap-2 bg-gray-700 p-3 rounded-lg text-sm';
                    listItem.style.gridTemplateColumns = '2fr repeat(8, 1fr)';
                    listItem.innerHTML = `<span>${name}</span>
                                          <span class="text-right">${item1.startStock}</span>
                                          <span class="text-right text-green-400">+${item1.receivedStock}</span>
                                          <span class="text-right">${item1.endStock}</span>
                                          <span class="text-right font-bold text-orange-400">${item1.consumption.toFixed(2)}</span>
                                          <span class="text-right">${item2.startStock}</span>
                                          <span class="text-right text-green-400">+${item2.receivedStock}</span>
                                          <span class="text-right">${item2.endStock}</span>
                                          <span class="text-right font-bold text-orange-400">${item2.consumption.toFixed(2)}</span>`;
                    el.consumptionResultList.appendChild(listItem);
                });
            }

            function renderRemitoConfirmView(detectedItems) {
                const baseInv = state.history.find(h => h.id === tempBaseInventoryId);
                if (!baseInv) {
                    alert("Error: No se pudo encontrar el inventario base.");
                    return;
                }

                tempRemitoItems = []; // Reiniciar la lista es crucial.
                const uniqueItemsFound = new Set();

                if (!Array.isArray(detectedItems)) {
                    console.error("'detectedItems' NO es un array. Deteniendo la ejecución.", detectedItems);
                    alert("El resultado del análisis no es una lista válida. Revisa la consola de desarrollador (F12).");
                    return;
                }

                detectedItems.forEach(detected => {
                    let bestMatch = null;
                    let highestScore = 0;
                    state.masterItems.forEach(masterItem => {
                        const score = stringSimilarity(detected.item.toUpperCase(), masterItem.toUpperCase());
                        if (score > highestScore && score > 0.7) {
                            highestScore = score;
                            bestMatch = masterItem;
                        }
                    });

                    if (bestMatch && !uniqueItemsFound.has(bestMatch)) {
                        tempRemitoItems.push({ name: bestMatch, quantity: detected.quantity });
                        uniqueItemsFound.add(bestMatch);
                    }
                });
                
                displayRemitoConfirmList();
                switchView(el.remitoConfirmView);
            }

            function displayRemitoConfirmList() {
                el.remitoConfirmList.innerHTML = '';

                tempRemitoItems.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg gap-2';
                    
                    const quantityValue = item.quantity ?? '';

                    listItem.innerHTML = `
                        <span class="flex-1 text-gray-200">${item.name}</span>
                        <input type="number" step="0.01" value="${quantityValue}" data-item-name="${item.name}" class="remito-quantity-input w-24 bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500">
                        <button data-item-name="${item.name}" class="delete-remito-item-btn bg-red-600 hover:bg-red-500 text-white font-bold w-10 h-10 flex items-center justify-center rounded-lg">&times;</button>
                    `;
                    el.remitoConfirmList.appendChild(listItem);
                });

                el.remitoConfirmList.querySelectorAll('.remito-quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const itemName = e.target.dataset.itemName;
                        const newQuantity = parseFloat(e.target.value) || 0;
                        const itemIndex = tempRemitoItems.findIndex(i => i.name === itemName);
                        if (itemIndex !== -1) {
                            tempRemitoItems[itemIndex].quantity = newQuantity;
                        }
                        updateRemitoSummaryFooter();
                    });
                });

                el.remitoConfirmList.querySelectorAll('.delete-remito-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemName = e.target.dataset.itemName;
                        tempRemitoItems = tempRemitoItems.filter(i => i.name !== itemName);
                        displayRemitoConfirmList(); 
                    });
                });

                updateAddItemDropdown();
                updateRemitoSummaryFooter();
            }

            function updateRemitoSummaryFooter() {
                const itemCount = tempRemitoItems.length;
                const bultoCount = tempRemitoItems.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);

                el.remitoItemCount.textContent = itemCount;
                el.remitoBultoCount.textContent = bultoCount.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function updateAddItemDropdown() {
                const currentItemNames = new Set(tempRemitoItems.map(i => i.name));
                const availableItems = state.masterItems.filter(item => !currentItemNames.has(item));
                
                el.addRemitoItemSelect.innerHTML = '<option value="">Seleccionar ítem...</option>';
                availableItems.sort().forEach(item => {
                    el.addRemitoItemSelect.innerHTML += `<option value="${item}">${item}</option>`;
                });
            }


            async function handleInventoryNext() {
                const rawValue = el.itemQuantity.value.replace(',', '.');
                const quantity = rawValue !== '' ? parseFloat(rawValue) : null;
                if (state.currentInventory && state.currentInventory.items[currentIndex]) {
                    state.currentInventory.items[currentIndex].quantity = (quantity !== null && !isNaN(quantity)) ? quantity : null;
                }
                advanceToNextItem('inventory');
            }

            async function handleOrderNext() {
                const rawValue = el.orderItemQuantity.value.replace(',', '.');
                const quantity = rawValue !== '' ? parseFloat(rawValue) : null;
                if (state.currentOrder && state.currentOrder.items[currentIndex]) {
                    state.currentOrder.items[currentIndex].toOrder = (quantity !== null && !isNaN(quantity)) ? quantity : null;
                }
                advanceToNextItem('order');
            }

            // --- Event Listeners ---
            el.continueInventoryBtn.addEventListener('click', () => {
                appMode = 'inventory';
                itemsToCountQueue = state.currentInventory.items.map((item, index) => ({...item, originalIndex: index})).filter(item => item.quantity === null).map(item => item.originalIndex);
                if (itemsToCountQueue.length > 0) {
                    positionInQueue = 0;
                    currentIndex = itemsToCountQueue[0];
                    switchView(el.item);
                    renderCurrentItem('inventory');
                } else {
                    renderSummaryList();
                    switchView(el.summary);
                }
            });

            el.continueOrderBtn.addEventListener('click', () => {
                appMode = 'order';
                itemsToCountQueue = state.currentOrder.items.map((item, index) => ({...item, originalIndex: index})).filter(item => item.toOrder === null).map(item => item.originalIndex);
                if (itemsToCountQueue.length > 0) {
                    positionInQueue = 0;
                    currentIndex = itemsToCountQueue[0];
                    switchView(el.orderItem);
                    renderCurrentItem('order');
                } else {
                    renderOrderSummaryList();
                    switchView(el.orderSummary);
                }
            });

            el.startNewInventoryBtn.addEventListener('click', () => {
                appMode = 'inventory';
                el.inventoryDate.value = new Date().toISOString().split('T')[0];
                switchView(el.setup);
            });

            el.makeOrderBtn.addEventListener('click', () => {
                appMode = 'order';
                renderHistoryList(true);
                switchView(el.selectInventory);
            });
            
            el.consumptionReportBtn.addEventListener('click', () => renderConsumptionSetup());
            el.historyBtn.addEventListener('click', () => { renderHistoryList(false); switchView(el.history); });
            el.manageItemsBtn.addEventListener('click', () => { renderManageItemsList(); switchView(el.manageItems); });

            el.startCountingBtn.addEventListener('click', async () => {
                const newInventory = {
                    id: String(Date.now()),
                    type: 'inventory',
                    date: el.inventoryDate.value,
                    timeOfDay: el.inventoryTime.value,
                    items: state.masterItems.map(name => ({ name, quantity: null }))
                };
                state.currentInventory = newInventory;
                itemsToCountQueue = state.currentInventory.items.map((_, index) => index);
                positionInQueue = 0;
                currentIndex = itemsToCountQueue[0];
                await setDoc(refs.currentInventory(), state.currentInventory);
                switchView(el.item);
                renderCurrentItem('inventory');
            });

            el.startOrderingBtn.addEventListener('click', () => {
                switchView(el.orderMethodView);
            });

            el.orderMethodManualBtn.addEventListener('click', async () => {
                const baseInv = state.history.find(h => h.id === tempBaseInventoryId);
                if (!baseInv) {
                    alert('Error: No se encontró el inventario base.');
                    return;
                }
                state.currentOrder = {
                    id: String(Date.now()),
                    type: 'order',
                    date: new Date().toISOString(),
                    orderForDate: el.orderForDate.value,
                    baseInventoryId: baseInv.id,
                    items: baseInv.items.map(item => ({ name: item.name, stock: item.quantity, toOrder: null, received: null }))
                };
                appMode = 'order';
                itemsToCountQueue = state.currentOrder.items.map((_, i) => i);
                positionInQueue = 0;
                currentIndex = itemsToCountQueue[0];
                await setDoc(refs.currentOrder(), state.currentOrder);
                switchView(el.orderItem);
                renderCurrentItem('order');
            });

            el.orderMethodRemitoBtn.addEventListener('click', () => {
                switchView(el.remitoUploadView);
            });

            // Inventory controls
            el.nextBtn.addEventListener('click', handleInventoryNext);
            el.naBtn.addEventListener('click', () => { if(state.currentInventory) { state.currentInventory.items[currentIndex].quantity = 'N/A'; advanceToNextItem('inventory'); } });
            el.skipBtn.addEventListener('click', () => { if(state.currentInventory) { advanceToNextItem('inventory'); } });
            el.itemQuantity.addEventListener('keydown', (e) => e.key === 'Enter' && handleInventoryNext());

            // Order controls
            el.orderNextBtn.addEventListener('click', handleOrderNext);
            el.orderNoPedirBtn.addEventListener('click', () => { if(state.currentOrder) { state.currentOrder.items[currentIndex].toOrder = 'NO PEDIR'; advanceToNextItem('order'); } });
            el.orderSkipBtn.addEventListener('click', () => { if(state.currentOrder) { advanceToNextItem('order'); } });
            el.orderItemQuantity.addEventListener('keydown', (e) => e.key === 'Enter' && handleOrderNext());

            // Back buttons
            el.backToCountBtn.addEventListener('click', () => switchView(el.item));
            el.backToOrderBtn.addEventListener('click', () => switchView(el.orderItem));
            el.backToHistoryBtn.addEventListener('click', () => switchView(el.history));
            el.backToMenuFromHistoryBtn.addEventListener('click', () => switchView(el.mainMenu));
            el.backToMenuFromManageBtn.addEventListener('click', () => switchView(el.mainMenu));
            el.backToMenuFromSelectInvBtn.addEventListener('click', () => switchView(el.mainMenu));
            el.backToSelectInvBtn.addEventListener('click', () => switchView(el.selectInventory));
            el.backToMenuFromConsumptionBtn.addEventListener('click', () => switchView(el.mainMenu));
            el.backToConsumptionSetupBtn.addEventListener('click', () => renderConsumptionSetup());
            el.backToHistoryFromEditBtn.addEventListener('click', () => switchView(el.history));
            el.backToHistoryFromEditInvBtn.addEventListener('click', () => switchView(el.history));
            el.backToSetupOrderBtn.addEventListener('click', () => switchView(el.setupOrder));
            el.backToOrderMethodBtn.addEventListener('click', () => switchView(el.orderMethodView));
            el.backToRemitoUploadBtn.addEventListener('click', () => switchView(el.remitoUploadView));

            el.addItemBtn.addEventListener('click', () => {
                const newName = el.newItemName.value.trim().toUpperCase();
                if (newName && !state.masterItems.includes(newName)) {
                    state.masterItems.push(newName);
                    setDoc(refs.masterItems(), { items: state.masterItems });
                    renderManageItemsList();
                    el.newItemName.value = '';
                    showToast(`'${newName}' fue agregado.`);
                } else if (!newName) {
                    alert('El nombre del ítem no puede estar vacío.');
                } else {
                     alert('Ese ítem ya existe.');
                }
            });

            el.saveAndFinishBtn.addEventListener('click', async () => {
                if (!state.currentInventory) return;
                try {
                    const batch = writeBatch(db);
                    const historyDocRef = refs.historyDoc(state.currentInventory.id);
                    batch.set(historyDocRef, state.currentInventory);
                    batch.delete(refs.currentInventory());
                    await batch.commit();
                    showToast('Inventario guardado.');
                    switchView(el.mainMenu);
                } catch (error) {
                    console.error("Error saving inventory:", error);
                }
            });
            
            el.saveOrderBtn.addEventListener('click', async () => {
                if (!state.currentOrder) return;
                try {
                    const batch = writeBatch(db);
                    const historyDocRef = refs.historyDoc(state.currentOrder.id);
                    batch.set(historyDocRef, state.currentOrder);
                    batch.delete(refs.currentOrder());
                    await batch.commit();
                    showToast('Pedido guardado.');
                    switchView(el.mainMenu);
                } catch (error) {
                    console.error("Error saving order:", error);
                }
            });

            el.saveEditedOrderBtn.addEventListener('click', async () => {
                const orderRef = refs.historyDoc(editingId);
                const orderData = { ...state.history.find(h => h.id == editingId) };
                
                el.editOrderList.querySelectorAll('input[data-index]').forEach(input => {
                    const itemIndex = parseInt(input.dataset.index, 10);
                    const rawValue = input.value.replace(',', '.');
                    const receivedQty = rawValue !== '' ? parseFloat(rawValue) : null;
                    orderData.items[itemIndex].received = receivedQty;
                });

                await updateDoc(orderRef, { items: orderData.items });
                showToast('Pedido actualizado!');
                switchView(el.history);
            });

            el.saveEditedInventoryBtn.addEventListener('click', async () => {
                const invRef = refs.historyDoc(editingId);
                const invData = { ...state.history.find(h => h.id == editingId) };

                el.editInventoryList.querySelectorAll('input[data-index]').forEach(input => {
                    const itemIndex = parseInt(input.dataset.index, 10);
                    const rawValue = input.value.replace(',', '.');
                    const qty = rawValue !== '' ? parseFloat(rawValue) : null;
                    invData.items[itemIndex].quantity = qty;
                });

                await updateDoc(invRef, { items: invData.items });
                showToast('Inventario actualizado!');
                switchView(el.history);
            });
            
            el.generateConsumptionReportBtn.addEventListener('click', renderConsumptionReport);
            el.startComparisonBtn.addEventListener('click', () => {
                el.comparisonContainer.classList.remove('hidden');
                el.generateComparisonBtn.classList.remove('hidden');
                el.startComparisonBtn.classList.add('hidden');
                el.generateConsumptionReportBtn.classList.add('hidden');
            });
            el.generateComparisonBtn.addEventListener('click', renderConsumptionComparison);
            el.consumptionSearch.addEventListener('input', (e) => {
                if (state.consumptionMode === 'single') {
                    renderConsumptionResultList(e.target.value);
                } else {
                    renderConsumptionComparisonList(e.target.value);
                }
            });
            el.orderFinishedDownloadPdfBtn.addEventListener('click', () => handleDownloadPdf(state.currentOrder, 'order'));
            el.finalDownloadBtn.addEventListener('click', () => handleDownloadPdf(state.currentInventory, 'inventory'));
            
            el.globalSummaryBtn.addEventListener('click', (e) => {
                if (e.target.dataset.context === 'order') {
                    renderOrderSummaryList();
                    switchView(el.orderSummary);
                } else {
                    renderSummaryList();
                    switchView(el.summary);
                }
            });
            
            el.globalPdfBtn.addEventListener('click', (e) => {
                if (e.target.dataset.context === 'order') {
                    handleDownloadPdf(state.currentOrder, 'order');
                } else {
                    handleDownloadPdf(state.currentInventory, 'inventory');
                }
            });
            
            el.saveAndExitBtn.addEventListener('click', async () => {
                if (appMode === 'inventory' && state.currentInventory) {
                    await setDoc(refs.currentInventory(), state.currentInventory);
                    showToast('Progreso de inventario guardado.');
                } else if (appMode === 'order' && state.currentOrder) {
                    await setDoc(refs.currentOrder(), state.currentOrder);
                    showToast('Progreso de pedido guardado.');
                }
                switchView(el.mainMenu);
            });

            el.discardProgressBtn.addEventListener('click', () => {
                const type = appMode === 'inventory' ? 'inventario' : 'pedido';
                el.confirmDeleteTitle.textContent = `¿Descartar ${type} en progreso?`;
                el.confirmDeleteMessage.textContent = 'Toda la información de este conteo se perderá permanentemente.';
                el.confirmDeleteModal.classList.remove('hidden');

                el.confirmDeleteBtn.onclick = async () => {
                    if (appMode === 'inventory' && state.currentInventory) {
                        await deleteDoc(refs.currentInventory());
                        state.currentInventory = null;
                    } else if (appMode === 'order' && state.currentOrder) {
                        await deleteDoc(refs.currentOrder());
                        state.currentOrder = null;
                    }
                    el.confirmDeleteModal.classList.add('hidden');
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} descartado.`);
                    switchView(el.mainMenu);
                };
            });

            el.cancelDeleteBtn.addEventListener('click', () => {
                el.confirmDeleteModal.classList.add('hidden');
            });

            el.authToggleBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                el.authTitle.textContent = isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
                el.authActionBtn.textContent = isLoginMode ? 'Iniciar Sesión' : 'Crear Cuenta';
                el.authToggleText.textContent = isLoginMode ? '¿No tienes cuenta?' : '¿Ya tienes cuenta?';
                el.authToggleBtn.textContent = isLoginMode ? 'Regístrate' : 'Inicia Sesión';
                el.loginError.textContent = '';
            });

            el.authActionBtn.addEventListener('click', () => {
                const email = el.emailInput.value;
                const password = el.passwordInput.value;
                el.loginError.textContent = '';

                if (!email || !password) {
                    el.loginError.textContent = 'Por favor, completa ambos campos.';
                    return;
                }

                if (isLoginMode) {
                    signInWithEmailAndPassword(auth, email, password)
                        .catch(error => {
                            console.error("Sign-in failed:", error);
                            el.loginError.textContent = 'Credenciales inválidas. Revisa tu correo y contraseña.';
                        });
                } else {
                    createUserWithEmailAndPassword(auth, email, password)
                        .catch(error => {
                            console.error("Sign-up failed:", error);
                            if (error.code === 'auth/email-already-in-use') {
                                el.loginError.textContent = 'Este correo ya está registrado. Intenta iniciar sesión.';
                                isLoginMode = true;
                                el.authTitle.textContent = 'Iniciar Sesión';
                                el.authActionBtn.textContent = 'Iniciar Sesión';
                                el.authToggleText.textContent = '¿No tienes cuenta?';
                                el.authToggleBtn.textContent = 'Regístrate';
                            } else if (error.code === 'auth/weak-password') {
                                el.loginError.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                            } else {
                                el.loginError.textContent = 'Error al crear la cuenta.';
                            }
                        });
                }
            });

            el.logoutBtn.addEventListener('click', () => {
                signOut(auth);
            });
            
            el.confirmRemitoDataBtn.addEventListener('click', async () => {
                const baseInv = state.history.find(h => h.id === tempBaseInventoryId);
                if (!baseInv) {
                    alert('Error: No se encontró el inventario base.');
                    return;
                }
                
                if(tempRemitoItems.length === 0){
                    alert('No hay ítems en la lista para crear un pedido.');
                    return;
                }

                const newOrder = {
                    id: String(Date.now()),
                    type: 'order',
                    date: new Date().toISOString(),
                    orderForDate: el.orderForDate.value,
                    baseInventoryId: baseInv.id,
                    items: tempRemitoItems.map(remitoItem => {
                        const baseItem = baseInv.items.find(bi => bi.name === remitoItem.name);
                        return {
                            name: remitoItem.name,
                            stock: baseItem ? baseItem.quantity : 'N/A',
                            toOrder: remitoItem.quantity,
                            received: remitoItem.quantity
                        };
                    })
                };

                try {
                    const historyDocRef = refs.historyDoc(newOrder.id);
                    await setDoc(historyDocRef, newOrder);
                    showToast('Pedido creado y guardado desde el remito.');
                    switchView(el.mainMenu);
                } catch (error) {
                    console.error("Error saving order from remito:", error);
                    alert('Hubo un error al guardar el pedido.');
                }
            });

            el.addRemitoItemBtn.addEventListener('click', () => {
                const itemName = el.addRemitoItemSelect.value;
                const rawValue = el.addRemitoItemQuantity.value.replace(',', '.');
                const quantity = parseFloat(rawValue);

                if (itemName && !isNaN(quantity) && quantity > 0) {
                    tempRemitoItems.push({ name: itemName, quantity: quantity });
                    tempRemitoItems.sort((a,b) => a.name.localeCompare(b.name));
                    displayRemitoConfirmList();
                    el.addRemitoItemSelect.value = '';
                    el.addRemitoItemQuantity.value = '';
                } else {
                    alert('Por favor, selecciona un ítem e ingresa una cantidad válida.');
                }
            });
            
            el.saveItemOrderBtn.addEventListener('click', async () => {
                await setDoc(refs.masterItems(), { items: state.masterItems });
                showToast('Orden de ítems guardado.');
            });

            el.inventorySummarySearch.addEventListener('input', (e) => renderSummaryList(e.target.value));
            el.orderSummarySearch.addEventListener('input', (e) => renderOrderSummaryList(e.target.value));
            el.manageItemsSearch.addEventListener('input', (e) => renderManageItemsList(e.target.value));

            el.remitoUploadCreation.addEventListener('change', () => {
                el.analyzeCreationRemitoBtn.disabled = !el.remitoUploadCreation.files.length;
                el.remitoPreviewContainer.innerHTML = ''; 

                if (el.remitoUploadCreation.files.length > 0) {
                    Array.from(el.remitoUploadCreation.files).forEach(file => {
                        const previewElement = document.createElement('div');
                        previewElement.className = 'p-2 bg-gray-700 rounded-lg text-xs text-center';

                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(file);
                            img.className = 'h-16 w-16 object-cover rounded-md mx-auto';
                            img.onload = () => URL.revokeObjectURL(img.src);
                            previewElement.appendChild(img);
                        } else if (file.type === 'application/pdf') {
                             previewElement.innerHTML = `<span class="block h-16 w-16 bg-red-800 text-white font-bold flex items-center justify-center rounded-md text-lg mx-auto">PDF</span>`;
                        }
                        const p = document.createElement('p');
                        p.textContent = file.name;
                        p.className = 'truncate mt-1 w-20';
                        previewElement.appendChild(p);

                        el.remitoPreviewContainer.appendChild(previewElement);
                    });
                }
            });

            el.analyzeCreationRemitoBtn.addEventListener('click', async () => {
                const files = el.remitoUploadCreation.files;
                if (!files || files.length === 0) {
                    alert("Por favor, selecciona uno o más archivos primero.");
                    return;
                }

                el.processingCreationLoader.classList.remove('hidden');
                el.analyzeCreationRemitoBtn.disabled = true;

                try {
                  
                    const prompt = `Tu tarea es actuar como un extractor de datos inteligente. Te proporcionaré una o más imágenes que, en conjunto, forman un **único documento o listado** (la lista puede continuar de una imagen a otra).

**Tu objetivo es analizar TODAS las imágenes como un solo conjunto y extraer una lista consolidada de productos y sus cantidades.**

Sigue estos pasos lógicos:
1.  **Consolida la Vista:** Primero, trata todas las imágenes como si fueran páginas de un mismo documento.
2.  **Identifica Columnas Clave:** Enfócate en las columnas que contienen el nombre del producto (usualmente llamada 'Artículo' o 'Descripción') y la cantidad (usualmente 'Cantidad'). Ignora por completo otras columnas como 'Código', 'Precio' o 'Costo'.
3.  **Extrae y Valida:** Recorre cada fila del listado completo (a través de todas las imágenes) y extrae el nombre del artículo. Compara ese nombre con la siguiente lista de productos válidos: [${state.masterItems.join(', ')}]. Solo procesa los artículos que coincidan.
4.  **Interpreta las Cantidades (Regla Crítica):** La cantidad en el documento puede usar una coma como separador decimal (ej: '2,00' debe ser 2; '15,50' debe ser 15.5). Es fundamental que interpretes 'X,00' como el número entero X, y no como Xcientos.

Finalmente, devuelve **UN ÚNICO ARRAY JSON** que contenga todos los artículos y cantidades válidos extraídos del documento completo. El formato debe ser estrictamente: '[{\"item\": \"NOMBRE_DEL_ITEM_VALIDADO\", \"quantity\": CANTIDAD_NUMERICA}]'`;
                    
                    const fileParts = await Promise.all(
                        Array.from(files).map(async (file) => {
                            const base64Data = await toBase64(file);
                            return { inlineData: { mimeType: file.type, data: base64Data } };
                        })
                    );

                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }, ...fileParts] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const apiKey = "AIzaSyCE-SnogYlIGq6rznk5ui8lcfX9EtoQZCs";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Error de la API: ${response.statusText}`);

                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const allDetectedItems = JSON.parse(jsonText);

                        const validItems = allDetectedItems.filter(item => item.quantity !== null && item.quantity !== undefined);
                        
                        renderRemitoConfirmView(validItems);

                    } else {
                        throw new Error('No se pudo extraer contenido de la respuesta de la API.');
                    }

                } catch (error) {
                    console.error("Error analizando el remito:", error);
                    alert("Hubo un error al procesar los archivos. Revisa la consola (F12) para más detalles.");
                } finally {
                    el.processingCreationLoader.classList.add('hidden');
                    el.analyzeCreationRemitoBtn.disabled = false;
                }
            });


        });
    </script>

</body>
</html>
