<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better mobile experience */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Style for number input to hide arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        /* Simple transition for views */
        .view { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 flex flex-col h-[90vh] relative">
        
        <!-- Vista de Configuración de Inventario -->
        <div id="setup-view" class="view flex flex-col h-full items-center justify-center text-center">
            <h1 class="text-3xl font-bold mb-2 text-gray-100">Nuevo Inventario</h1>
            <p class="text-gray-400 mb-8">Configura los detalles de este conteo.</p>
            <div class="w-full space-y-4">
                <div>
                    <label for="inventory-date" class="block text-left text-sm font-medium text-gray-300 mb-1">Fecha del Stock</label>
                    <input type="date" id="inventory-date" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500">
                </div>
                <div>
                    <label for="inventory-time" class="block text-left text-sm font-medium text-gray-300 mb-1">Momento del Día</label>
                    <select id="inventory-time" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500">
                        <option>Apertura</option>
                        <option>Intermedio</option>
                        <option>Cierre</option>
                    </select>
                </div>
            </div>
            <button id="start-inventory-btn" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Comenzar Inventario</button>
        </div>

        <!-- Vista de Conteo de Items -->
        <div id="item-view" class="view hidden flex-col h-full">
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                <p id="item-counter" class="text-sm font-medium text-indigo-400 mb-2">Ítem 1/123</p>
                <h1 id="item-name" class="text-3xl font-bold mb-6 text-gray-100">Nombre del Ítem</h1>
                <input type="number" id="item-quantity" placeholder="Ingresa la cantidad" class="w-full bg-gray-700 text-white text-center text-2xl p-4 rounded-lg border-2 border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 transition duration-300">
            </div>
            <div class="mt-auto grid grid-cols-2 gap-4">
                <button id="skip-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Saltar</button>
                <button id="next-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Siguiente</button>
            </div>
        </div>

        <!-- Vista de Resumen -->
        <div id="summary-view" class="view hidden flex-col h-full">
            <h1 class="text-2xl font-bold mb-4 text-center text-gray-100">Resumen de Inventario</h1>
            <div id="summary-list" class="flex-grow overflow-y-auto pr-2 space-y-3"></div>
            <div class="mt-auto">
                <button id="back-to-count-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Volver al Conteo</button>
            </div>
        </div>
        
        <!-- Vista Final -->
        <div id="finished-view" class="view hidden flex-col h-full items-center justify-center text-center">
             <h1 class="text-3xl font-bold mb-4 text-green-400">¡Inventario Completo!</h1>
             <p class="text-gray-300 mb-6">Has ingresado todos los artículos.</p>
             <div class="w-full space-y-4">
                <button id="final-summary-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Ver Resumen Final</button>
                <button id="final-download-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Descargar PDF</button>
             </div>
        </div>

        <!-- Botones de Navegación Global -->
        <div id="nav-buttons" class="mt-6 flex justify-center space-x-4">
            <button id="summary-btn" class="bg-gray-700 hover:bg-gray-600 text-sm text-gray-300 font-medium py-2 px-4 rounded-lg transition duration-300">Resumen</button>
            <button id="download-pdf-btn" class="bg-gray-700 hover:bg-gray-600 text-sm text-gray-300 font-medium py-2 px-4 rounded-lg transition duration-300">PDF</button>
            <button id="new-inventory-btn" class="bg-red-800 hover:bg-red-700 text-sm text-white font-medium py-2 px-4 rounded-lg transition duration-300">Nuevo Inventario</button>
        </div>
    </div>
    
    <!-- Modal de Confirmación -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 text-center shadow-xl">
            <h3 class="text-lg font-bold text-white mb-2">¿Estás seguro?</h3>
            <p class="text-gray-300 mb-6">Se borrará todo el progreso del inventario actual.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-reset-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'inventoryAppData';

            const initialItemsList = [
                "ACEITE FRITURA", "ALMIBAR PARA FACTURA X 7 KG", "AZUCAR INDIVIDUAL KFC", "BANDEJA CANOA KFC", 
                "BOLSA DE LLEVAR GRANDE KFC2", "BOLSA DE RESIDUOS CHICA", "BOLSA DE RESIDUOS NEGRA X 250 UND", 
                "BOLSA DE RESIDUOS TRANSPARENTE", "BOLSA PARA MARINADO K EN ROLLOS", "BOLSA SIN MANIJA GRANDE KFC X 250 UND", 
                "BUCKET 130OZ KFC X 300UN", "BUCKET 50OZ X 420 UND", "BUCKET 85OZ X 330 UND", "CAFE EN POLVO", 
                "CAJA BIG BOXKFC", "CAJA SNACK CON TAPA KFC X 800 UND", "CANDADITOS KFC", "CHOCOLATE CON MANI X 4.32KG", 
                "CHOCOLATE EN POLVO X 4KG", "CINTA DE SEGURIDAD KFC X 36 UND", "COFIA DE FISELINA DESCARTABLE", 
                "CONO HELADO", "CUCHARITA PARA HELADO X 1000 UND", "CUCHILLO", "EDULCORANTE INDIVIDUAL KFC", 
                "ESTUCHE PAPA CHICA KFC X 800 UND", "ESTUCHE PAPAS GRANDES KFC", "ESTUCHE PAPAS MEDIANAS KFC", 
                "ESTUCHE POPCORN GRANDE", "ESTUCHE POPCORN MEDIANO", "ETC TEMPERO", "FILTRO FREIDORAS FRYMASTER", 
                "FILTRO FREIDORAS HENNY PENNY", "GALLETITA OREO CAJA X36 X 117 GR", "GUANTES VINILO M", 
                "HARINA X 11.389KG", "JUGO DE LIMON INDIVIDUAL", "KETCHUP INDIVIDUAL", "LAMINA ANTIGRASA SANDWICH KFC X1500", 
                "LECHE EN POLVO CAJAX10KG", "MANTECOL", "MANTELITO KFC", "MAYONESA INDIVIDUAL", "MEZCLA HUEVO/LECHE", 
                "MOSTAZA CON MIEL", "MOSTAZA CON MIEL INDIVIDUAL", "MOSTAZA INDIVIDUAL", "PAÑO BLANCO X 300 UN", 
                "PAÑO AZUL", "PAÑO ROJO", "PAPEL ANTIGRASA BLANCO", "PAPEL ANTIGRASA GENERICO CAJA X 4000", 
                "PAPEL ANTIGRASA SANDWICH KFC 2", "PAPEL DE MANOS (TO)", "PAPEL FILM (ROLLO)", "PAPEL HIGIENICO", 
                "PAPEL SILICONADO X 500 UND", "PORTAVASOS KFC X 200 UND", "REVOLVEDOR CAFE MADERA", 
                "ROLLO IMPRESORA FISCAL GENERICO 2", "SAL A GRANEL", "SAL SOBRE INDIVIDUAL KFC", 
                "SALSA BARBACOA A GRANEL", "SALSA BARBACOA INDIVIDUAL", "SALSA PICANTE A GRANEL", 
                "SALSA PICANTE INDIVIDUAL", "SEASONING OR", "SERVILLETAS 30X30 X 5000 UND", "SERVILLETAS PARA CONO", 
                "SOBRE KFC X 1000 UND", "STICKER REDONDO AMARILLO", "STICKER REDONDO AZUL", "STICKER REDONDO NARANJA", 
                "STICKER REDONDO NEGRO", "STICKER REDONDO ROJO", "STICKER REDONDO VERDE", "STICKER VENCIMIENTO", 
                "SUNDAE KFC 7.25 OZ X 2000 UND", "TAPA BUCKET KFC X 2150 UND", "TAPA CAJA BIG BOX", "TAPA DIPPER", 
                "TAPA VASO CAFE 8 Y 12 OZ X 2000 UND", "TAPA VASO GASEOSA 16OZ", "TAPA VASO GASEOSA 12OZ", 
                "TE INTIZEN ILUMINE (ROJO)", "TENEDOR", "QUESO CHEDDAR EN POLVO", "VASO AVALANCHA KFC X 1200 UND", 
                "VASO CAFE 8 OZ KFC", "VASO CORTESIA KFC", "VASO GASEOSA 12OZ KFC A", "VASO GASEOSA 16OZ KFC A", 
                "VASO GASEOSA 21OZ KFC", "VASO CAFE 12 OZ KFC X 1000", "HELADO DULCE DE LECHE", "HELADO VAINILLA", 
                "JARABE DE FRUTILLA", "SALSA DE CHOCOLATE", "SALSA DE DULCE DE LECHE X 5KG", "QUESO CHEDDAR EN FETAS 2", 
                "LOMITO EN FETAS", "PANCETA KFC", "MANTECA X 6KG", "MAYONESA A GRANEL", "MIXDE ENSALADA", "TOMATE", 
                "PAN PORTENO", "PANAL MEMBRILLO X 72 UND", "REJILLA PASTELERA X 72 UND", "MEDIALUNA DE GRASA X 240 UND", 
                "MEDIALUNA DE MANTECA X 180 UND", "HELADO CONG SUNDAE CHOC", "HELADO CONGELADO SUNDAE DDL", 
                "HELADO CONGELADO AVALANCHA KFC", "PAPAS FRITAS KFC C7 X 18 KG", "AROS DE CEBOLLA X 10KG"
            ];

            // --- ESTADO DE LA APLICACIÓN ---
            let state = {
                date: '',
                timeOfDay: '',
                items: []
            };
            let currentIndex = 0;
            let itemsToCountQueue = [];
            let positionInQueue = -1;

            // --- ELEMENTOS DEL DOM ---
            const allViews = document.querySelectorAll('.view');
            const setupView = document.getElementById('setup-view');
            const itemView = document.getElementById('item-view');
            const summaryView = document.getElementById('summary-view');
            const finishedView = document.getElementById('finished-view');
            const navButtons = document.getElementById('nav-buttons');
            const confirmModal = document.getElementById('confirm-modal');

            const inventoryDateEl = document.getElementById('inventory-date');
            const inventoryTimeEl = document.getElementById('inventory-time');
            const startInventoryBtn = document.getElementById('start-inventory-btn');
            
            const itemNameEl = document.getElementById('item-name');
            const itemQuantityEl = document.getElementById('item-quantity');
            const itemCounterEl = document.getElementById('item-counter');
            
            const summaryListEl = document.getElementById('summary-list');
            
            const nextBtn = document.getElementById('next-btn');
            const skipBtn = document.getElementById('skip-btn');
            const summaryBtn = document.getElementById('summary-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const backToCountBtn = document.getElementById('back-to-count-btn');
            const finalSummaryBtn = document.getElementById('final-summary-btn');
            const finalDownloadBtn = document.getElementById('final-download-btn');
            const newInventoryBtn = document.getElementById('new-inventory-btn');
            const cancelResetBtn = document.getElementById('cancel-reset-btn');
            const confirmResetBtn = document.getElementById('confirm-reset-btn');

            // --- LÓGICA DE MANEJO DE ESTADO ---
            function saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                    return true;
                }
                return false;
            }

            function switchView(viewToShow) {
                allViews.forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
                navButtons.style.display = (viewToShow === setupView) ? 'none' : 'flex';
            }

            // --- LÓGICA DE LA APLICACIÓN ---
            function renderCurrentItem() {
                if (currentIndex < 0 || currentIndex >= state.items.length) {
                    console.error("Índice inválido", currentIndex);
                    return;
                }
                const item = state.items[currentIndex];
                itemNameEl.textContent = item.name;
                itemCounterEl.textContent = `Ítem ${positionInQueue + 1} de ${itemsToCountQueue.length}`;
                itemQuantityEl.value = item.quantity === null ? '' : item.quantity;
                itemQuantityEl.focus();
            }

            function advanceToNextItem() {
                positionInQueue++;
                if (positionInQueue >= itemsToCountQueue.length) {
                    const remainingIndices = state.items
                        .map((item, index) => ({ ...item, originalIndex: index }))
                        .filter(item => item.quantity === null)
                        .map(item => item.originalIndex);

                    if (remainingIndices.length > 0) {
                        itemsToCountQueue = remainingIndices;
                        positionInQueue = 0;
                        currentIndex = itemsToCountQueue[positionInQueue];
                        renderCurrentItem();
                    } else {
                        switchView(finishedView);
                    }
                } else {
                    currentIndex = itemsToCountQueue[positionInQueue];
                    renderCurrentItem();
                }
                saveState();
            }

            function handleNext() {
                const quantity = itemQuantityEl.value;
                state.items[currentIndex].quantity = quantity !== '' ? parseInt(quantity, 10) : null;
                advanceToNextItem();
            }

            function handleSkip() {
                state.items[currentIndex].quantity = null; // Ensure it's marked as skipped
                advanceToNextItem();
            }

            function renderSummaryList() {
                summaryListEl.innerHTML = '';
                state.items.forEach((item, index) => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    
                    const itemName = document.createElement('span');
                    itemName.textContent = item.name;
                    itemName.className = 'flex-1 mr-4 text-gray-200';
                    
                    const itemInput = document.createElement('input');
                    itemInput.type = 'number';
                    itemInput.value = item.quantity ?? '';
                    itemInput.placeholder = 'N/A';
                    itemInput.className = 'w-24 bg-gray-600 text-white text-center p-2 rounded-md border border-gray-500 focus:border-indigo-500';
                    itemInput.dataset.index = index;

                    itemInput.addEventListener('change', (e) => {
                        const newQuantity = e.target.value;
                        const itemIndex = parseInt(e.target.dataset.index, 10);
                        state.items[itemIndex].quantity = newQuantity === '' ? null : parseInt(newQuantity, 10);
                        saveState();
                    });

                    listItem.appendChild(itemName);
                    listItem.appendChild(itemInput);
                    summaryListEl.appendChild(listItem);
                });
            }

            function handleDownloadPdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const countedItems = state.items.filter(item => item.quantity !== null);

                if (countedItems.length === 0) {
                    alert('No hay items con cantidad para generar el PDF.');
                    return;
                }

                doc.setFontSize(18);
                doc.text("Resumen de Inventario", 14, 22);
                doc.setFontSize(11);
                
                const inventoryDate = new Date(state.date);
                // Adjust for timezone offset to show correct date
                inventoryDate.setMinutes(inventoryDate.getMinutes() + inventoryDate.getTimezoneOffset());
                doc.text(`Fecha: ${inventoryDate.toLocaleDateString('es-AR')} - Momento: ${state.timeOfDay}`, 14, 30);

                let y = 40;
                const pageHeight = doc.internal.pageSize.height;

                countedItems.forEach(item => {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(`${item.name}: ${item.quantity}`, 14, y);
                    y += 7;
                });

                doc.save(`inventario_${state.date}_${state.timeOfDay}.pdf`);
            }

            function handleReset() {
                confirmModal.classList.remove('hidden');
            }
            
            // --- INICIALIZACIÓN ---
            function initialize() {
                if (loadState()) {
                    // Hay un inventario guardado, continuar
                    itemsToCountQueue = state.items
                        .map((item, index) => ({ ...item, originalIndex: index }))
                        .filter(item => item.quantity === null)
                        .map(item => item.originalIndex);
                    
                    if (itemsToCountQueue.length > 0) {
                        positionInQueue = 0;
                        currentIndex = itemsToCountQueue[positionInQueue];
                        switchView(itemView);
                        renderCurrentItem();
                    } else {
                        // Todos los items ya fueron contados
                        switchView(finishedView);
                    }
                } else {
                    // No hay inventario, mostrar pantalla de configuración
                    const today = new Date().toISOString().split('T')[0];
                    inventoryDateEl.value = today;
                    switchView(setupView);
                }
            }

            // --- EVENT LISTENERS ---
            startInventoryBtn.addEventListener('click', () => {
                state.date = inventoryDateEl.value;
                state.timeOfDay = inventoryTimeEl.value;
                state.items = initialItemsList.map(name => ({ name, quantity: null }));
                
                itemsToCountQueue = state.items.map((_, index) => index);
                positionInQueue = 0;
                currentIndex = itemsToCountQueue[positionInQueue];
                
                saveState();
                switchView(itemView);
                renderCurrentItem();
            });

            nextBtn.addEventListener('click', handleNext);
            skipBtn.addEventListener('click', handleSkip);
            summaryBtn.addEventListener('click', () => { renderSummaryList(); switchView(summaryView); });
            backToCountBtn.addEventListener('click', () => { switchView(itemView); renderCurrentItem(); });
            downloadPdfBtn.addEventListener('click', handleDownloadPdf);
            
            finalSummaryBtn.addEventListener('click', () => { renderSummaryList(); switchView(summaryView); });
            finalDownloadBtn.addEventListener('click', handleDownloadPdf);

            newInventoryBtn.addEventListener('click', handleReset);
            cancelResetBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
            confirmResetBtn.addEventListener('click', () => {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            });

            itemQuantityEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleNext();
                }
            });

            initialize();
        });
    </script>

</body>
</html>
